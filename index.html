<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WS Fitness</title>
  <style>
    :root{
      --bg1:#0f172a; --bg2:#111827; --card:#1e293b; --ink:#e5e7eb;
      --muted:#94a3b8; --blue:#38bdf8; --blue2:#2563eb; --red:#fecaca; --green:#bbf7d0;
      --line:#334155;
    }
    body{
      margin:0; padding:18px; color:var(--ink);
      font-family: Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 10%, #0b3b6a22, transparent 60%),
                  radial-gradient(1200px 800px at 90% 30%, #2563eb22, transparent 55%),
                  linear-gradient(135deg,var(--bg1),var(--bg2));
    }
    h1{margin:0 0 14px; text-align:center; color:var(--blue); letter-spacing:.4px}
    .wrap{max-width:880px;margin:0 auto}
    .card{
      background: rgba(30,41,59,.85);
      border:1px solid rgba(51,65,85,.7);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 14px 40px rgba(0,0,0,.25);
      backdrop-filter: blur(8px);
      margin-bottom:12px;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .col{flex:1; min-width:220px}
    label{display:block; margin:10px 0 6px; font-weight:800}
    input,select{
      width:100%;
      box-sizing:border-box;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(51,65,85,.9);
      background:#0b1220;
      color:var(--ink);
      outline:none;
      font-size:15px;
    }
    input::placeholder{color:#64748b}
    button{
      width:100%;
      padding:13px 14px;
      border-radius:14px;
      border:0;
      background: linear-gradient(90deg,var(--blue),var(--blue2));
      color:white;
      font-weight:900;
      font-size:16px;
      cursor:pointer;
      margin-top:10px;
    }
    button.secondary{
      background:#0b1220;
      border:1px solid rgba(51,65,85,.9);
      color:var(--ink);
    }
    button.danger{
      background:#ef4444;
    }
    .pill{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      background:#0b1220; border:1px solid rgba(51,65,85,.9);
      border-radius:14px; padding:10px 12px;
    }
    .pill b{color:var(--blue)}
    .badge{display:inline-flex; align-items:center; gap:8px; padding:7px 10px; border-radius:999px;
      background:#0b1220; border:1px solid rgba(51,65,85,.9); color:var(--muted); font-weight:900; font-size:12px}
    .msg{margin-top:10px; padding:10px 12px; border-radius:12px; border:1px solid rgba(51,65,85,.9); background:#0b1220}
    .msg.ok{color:var(--green)}
    .msg.err{color:var(--red)}
    .muted{color:var(--muted); font-size:13px; line-height:1.6}
    .tabs{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .tab{
      flex:1; min-width:160px;
      border:1px solid rgba(51,65,85,.9);
      background:#0b1220;
      color:var(--ink);
      border-radius:12px;
      padding:12px;
      font-weight:900;
      cursor:pointer;
    }
    .tab.active{background:linear-gradient(90deg,var(--blue),var(--blue2)); border:0}
    .hidden{display:none !important}
    .hr{height:1px;background:rgba(51,65,85,.9);margin:12px 0;border-radius:999px}
    code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace}
  </style>
</head>

<body>
<div class="wrap">
  <h1>WS Fitness</h1>

  <!-- STATUS -->
  <div class="card">
    <div class="pill">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        Session: <b id="sessEmail">—</b>
        <span class="badge" id="sessRole">ROLE: —</span>
        <span class="badge" id="sessUid">UID: —</span>
        <span class="badge" id="sessSub">SUB: —</span>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <span class="badge" id="conn">Firebase: —</span>
        <button class="secondary" style="width:auto;margin:0;padding:10px 12px" id="logoutBtn" onclick="logout()" disabled>Logout</button>
      </div>
    </div>
    <div class="muted" style="margin-top:10px">
      • Roles: admin / coach / subscriber / user<br>
      • Subscriber login is blocked automatically after subscription expiry.
    </div>
  </div>

  <!-- AUTH -->
  <div class="card" id="authCard">
    <div class="tabs">
      <button class="tab active" id="tabLogin" onclick="setMode('login')">Login</button>
      <button class="tab" id="tabUser" onclick="setMode('user')">Create User</button>
      <button class="tab" id="tabCoach" onclick="setMode('coach')">Create Coach</button>
      <button class="tab" id="tabSub" onclick="setMode('subscriber')">Create Subscriber</button>
    </div>

    <div id="panelLogin">
      <div class="row">
        <div class="col">
          <label>Email</label>
          <input id="loginEmail" placeholder="email@example.com" inputmode="email" autocomplete="email">
        </div>
        <div class="col">
          <label>Password</label>
          <input id="loginPass" type="password" placeholder="••••••••" autocomplete="current-password">
        </div>
      </div>
      <button onclick="login()">Login</button>
    </div>

    <div id="panelUser" class="hidden">
      <div class="row">
        <div class="col">
          <label>Name</label>
          <input id="userName" placeholder="name">
        </div>
        <div class="col">
          <label>Email</label>
          <input id="userEmail" placeholder="email@example.com" inputmode="email" autocomplete="email">
        </div>
        <div class="col">
          <label>Password</label>
          <input id="userPass" type="password" placeholder="min 6 characters" autocomplete="new-password">
        </div>
      </div>
      <button onclick="createAccount('user')">Create User</button>
    </div>

    <div id="panelCoach" class="hidden">
      <div class="row">
        <div class="col">
          <label>Name</label>
          <input id="coachName" placeholder="coach name">
        </div>
        <div class="col">
          <label>Email</label>
          <input id="coachEmail" placeholder="email@example.com" inputmode="email" autocomplete="email">
        </div>
        <div class="col">
          <label>Password</label>
          <input id="coachPass" type="password" placeholder="min 6 characters" autocomplete="new-password">
        </div>
      </div>
      <button onclick="createAccount('coach')">Create Coach</button>
    </div>

    <div id="panelSubscriber" class="hidden">
      <div class="row">
        <div class="col">
          <label>Name</label>
          <input id="subName" placeholder="subscriber name">
        </div>
        <div class="col">
          <label>Email</label>
          <input id="subEmail" placeholder="email@example.com" inputmode="email" autocomplete="email">
        </div>
        <div class="col">
          <label>Password</label>
          <input id="subPass" type="password" placeholder="min 6 characters" autocomplete="new-password">
        </div>
        <div class="col">
          <label>Invite Code</label>
          <input id="subInvite" class="mono" placeholder="e.g. 9K4Q8Z2M" autocomplete="off" autocapitalize="characters">
        </div>
      </div>
      <button onclick="createSubscriberWithInvite()">Create Subscriber</button>
      <div class="muted">Subscriber must have a valid Invite Code from a coach.</div>
    </div>

    <div id="msg" class="msg hidden"></div>
  </div>

  <!-- APP -->
  <div class="card hidden" id="appCard">
    <div style="font-weight:900;color:var(--blue);font-size:18px">Dashboard</div>
    <div class="muted" style="margin-top:8px" id="dashText">—</div>

    <div class="hr"></div>

    <!-- COACH PANEL -->
    <div id="coachPanel" class="hidden">
      <div style="font-weight:900;color:var(--blue);font-size:16px">Coach Panel: Invite Codes</div>
      <div class="muted">Create an invite code and send it to your subscriber.</div>

      <div class="row">
        <div class="col">
          <label>Subscription Months (1–6)</label>
          <select id="invMonths">
            <option value="1">1 month</option>
            <option value="2">2 months</option>
            <option value="3">3 months</option>
            <option value="4">4 months</option>
            <option value="5">5 months</option>
            <option value="6">6 months</option>
          </select>
        </div>
        <div class="col">
          <label>Invite Code Length</label>
          <select id="invLen">
            <option value="6">6</option>
            <option value="8" selected>8</option>
            <option value="10">10</option>
          </select>
        </div>
      </div>

      <button onclick="coachCreateInvite()">Generate Invite Code</button>

      <div class="msg ok hidden" id="inviteOut"></div>
      <button class="secondary" onclick="copyInvite()" id="copyBtn" disabled>Copy Invite Code</button>
    </div>

    <!-- ADMIN PANEL -->
    <div id="adminPanel" class="hidden">
      <div class="hr"></div>
      <div style="font-weight:900;color:var(--blue);font-size:16px">Admin Panel</div>

      <div class="row">
        <div class="col">
          <label>Target UID</label>
          <input id="adminTargetUid" class="mono" placeholder="paste UID">
        </div>
        <div class="col">
          <label>Set Role</label>
          <select id="adminRole">
            <option value="user">user</option>
            <option value="coach">coach</option>
            <option value="subscriber">subscriber</option>
            <option value="admin">admin</option>
          </select>
        </div>
      </div>
      <button onclick="adminSetRole()">Update Role</button>
      <div class="muted">Note: subscriber role usually created through Invite signup (recommended).</div>
    </div>
  </div>

  <!-- RULES NOTE -->
  <div class="card">
    <div style="font-weight:900;color:var(--blue);font-size:16px">Important: Firestore Rules</div>
    <div class="muted">
      If your Firestore rules are still “open testing rules”, replace them with the rules I provide below so roles/invites are protected.
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    updateDoc,
    serverTimestamp,
    Timestamp,
    runTransaction
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAK06AL_e24OQuoWvNmp9I6Xkc2Yx9ZoBc",
    authDomain: "ws-fitness.firebaseapp.com",
    projectId: "ws-fitness",
    storageBucket: "ws-fitness.firebasestorage.app",
    messagingSenderId: "639434705944",
    appId: "1:639434705944:web:4f0eef88b76e4d856c076d",
    measurementId: "G-BZG7GS5ZDW"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const el = (id)=>document.getElementById(id);
  const msgBox = el("msg");

  let lastInviteCode = "";

  function showMsg(text, ok=false){
    msgBox.classList.remove("hidden","ok","err");
    msgBox.classList.add(ok ? "ok" : "err");
    msgBox.textContent = text;
  }
  function clearMsg(){ msgBox.classList.add("hidden"); msgBox.textContent=""; }

  window.setMode = (mode)=>{
    clearMsg();
    el("tabLogin").classList.toggle("active", mode==="login");
    el("tabUser").classList.toggle("active", mode==="user");
    el("tabCoach").classList.toggle("active", mode==="coach");
    el("tabSub").classList.toggle("active", mode==="subscriber");

    el("panelLogin").classList.toggle("hidden", mode!=="login");
    el("panelUser").classList.toggle("hidden", mode!=="user");
    el("panelCoach").classList.toggle("hidden", mode!=="coach");
    el("panelSubscriber").classList.toggle("hidden", mode!=="subscriber");
  };

  // ----- AUTH -----
  window.login = async ()=>{
    clearMsg();
    const email = (el("loginEmail").value||"").trim();
    const pass  = (el("loginPass").value||"").trim();
    if(!email || !pass) return showMsg("Enter email + password.");
    try{
      await signInWithEmailAndPassword(auth, email, pass);
      showMsg("Logged in ✅", true);
    }catch(e){
      showMsg(`Login error: ${e.code || ""} ${e.message || e}`);
    }
  };

  window.createAccount = async (role)=>{
    clearMsg();
    const nameEl = role==="coach" ? el("coachName") : el("userName");
    const emailEl= role==="coach" ? el("coachEmail") : el("userEmail");
    const passEl = role==="coach" ? el("coachPass") : el("userPass");

    const name = (nameEl.value||"").trim();
    const email= (emailEl.value||"").trim();
    const pass = (passEl.value||"").trim();

    if(!name || !email || !pass) return showMsg("Enter name + email + password.");
    if(pass.length < 6) return showMsg("Password must be at least 6 characters.");

    try{
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      const uid = cred.user.uid;

      await setDoc(doc(db, "users", uid), {
        name,
        role,                 // user | coach
        active: true,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      }, { merge:true });

      showMsg(`Account created as ${role.toUpperCase()} ✅`, true);
    }catch(e){
      showMsg(`Create error: ${e.code || ""} ${e.message || e}`);
    }
  };

  window.createSubscriberWithInvite = async ()=>{
    clearMsg();
    const name = (el("subName").value||"").trim();
    const email= (el("subEmail").value||"").trim();
    const pass = (el("subPass").value||"").trim();
    const invite = (el("subInvite").value||"").trim().toUpperCase();

    if(!name || !email || !pass || !invite) return showMsg("Enter name + email + password + invite code.");
    if(pass.length < 6) return showMsg("Password must be at least 6 characters.");

    try{
      // Create auth user first (user becomes signed in automatically)
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      const uid = cred.user.uid;

      // Transaction: validate invite, create subscriber doc, mark invite used
      await runTransaction(db, async (tx)=>{
        const invRef = doc(db, "invites", invite);
        const invSnap = await tx.get(invRef);
        if(!invSnap.exists()) throw new Error("Invalid invite code.");

        const inv = invSnap.data();
        if(inv.usedBy) throw new Error("Invite already used.");
        if(inv.expiresAt && inv.expiresAt.toMillis() <= Date.now()) throw new Error("Invite expired.");

        const coachId = inv.coachId;
        const months = Number(inv.months || 1);
        const startMs = Date.now();
        const expMs = addMonthsMillis(startMs, clamp(months,1,6));

        const userRef = doc(db, "users", uid);
        tx.set(userRef, {
          name,
          role: "subscriber",
          coachId,
          inviteCode: invite,
          active: true,
          subStartAt: Timestamp.fromMillis(startMs),
          subExpiresAt: Timestamp.fromMillis(expMs),
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge:true });

        tx.update(invRef, {
          usedBy: uid,
          usedAt: serverTimestamp()
        });
      });

      showMsg("Subscriber created ✅", true);
    }catch(e){
      showMsg(`Subscriber error: ${e.code || ""} ${e.message || e}`);
      // If Firestore fails after auth creation, you might end up with auth user but no profile doc.
      // You can delete that auth user later in console if needed.
    }
  };

  window.logout = async ()=>{
    clearMsg();
    await signOut(auth);
  };

  // ----- INVITES -----
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  function makeCode(len=8){
    const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let s="";
    for(let i=0;i<len;i++) s += chars[Math.floor(Math.random()*chars.length)];
    return s;
  }

  function addMonthsMillis(startMs, months){
    const d = new Date(startMs);
    const day = d.getDate();
    d.setMonth(d.getMonth()+months);
    if(d.getDate() < day) d.setDate(0);
    return d.getTime();
  }

  window.coachCreateInvite = async ()=>{
    clearMsg();
    const user = auth.currentUser;
    if(!user) return showMsg("Please login.");

    try{
      const prof = await getDoc(doc(db,"users",user.uid));
      const role = prof.exists() ? prof.data().role : "";
      if(role !== "coach" && role !== "admin") return showMsg("Only coach/admin can create invites.");

      const months = clamp(Number(el("invMonths").value||"1"),1,6);
      const len = clamp(Number(el("invLen").value||"8"),6,10);

      // Try few times to avoid collisions
      let code = "";
      for(let i=0;i<5;i++){
        const c = makeCode(len);
        const test = await getDoc(doc(db,"invites",c));
        if(!test.exists()){ code = c; break; }
      }
      if(!code) throw new Error("Try again (code collision).");

      const now = Date.now();
      const expiresAt = Timestamp.fromMillis(now + (14*24*60*60*1000)); // Invite itself expires in 14 days

      await setDoc(doc(db,"invites",code),{
        coachId: user.uid,
        months,
        createdAt: serverTimestamp(),
        expiresAt,
        usedBy: null,
        usedAt: null
      });

      lastInviteCode = code;
      el("inviteOut").classList.remove("hidden");
      el("inviteOut").textContent = `Invite Code: ${code}  |  Subscription: ${months} month(s)`;
      el("copyBtn").disabled = false;

      showMsg("Invite created ✅", true);
    }catch(e){
      showMsg(`Invite error: ${e.code || ""} ${e.message || e}`);
    }
  };

  window.copyInvite = async ()=>{
    if(!lastInviteCode) return;
    try{
      await navigator.clipboard.writeText(lastInviteCode);
      showMsg("Copied ✅", true);
    }catch{
      showMsg("Copy failed. You can manually copy from the invite box.");
    }
  };

  // ----- ADMIN -----
  window.adminSetRole = async ()=>{
    clearMsg();
    const user = auth.currentUser;
    if(!user) return showMsg("Please login.");

    try{
      const meSnap = await getDoc(doc(db,"users",user.uid));
      const myRole = meSnap.exists() ? meSnap.data().role : "";
      if(myRole !== "admin") return showMsg("Admin only.");

      const targetUid = (el("adminTargetUid").value||"").trim();
      const role = el("adminRole").value;

      if(!targetUid) return showMsg("Enter target UID.");
      await updateDoc(doc(db,"users",targetUid), { role, updatedAt: serverTimestamp() });
      showMsg("Role updated ✅", true);
    }catch(e){
      showMsg(`Admin error: ${e.code || ""} ${e.message || e}`);
    }
  };

  // ----- SESSION -----
  function fmtDate(ms){
    const d=new Date(ms);
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    const da=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }

  async function checkSubscriptionOrSignOut(profile){
    if(profile?.role !== "subscriber") return true;
    const exp = profile?.subExpiresAt;
    if(!exp) return true;
    const expMs = exp.toMillis ? exp.toMillis() : Number(exp);
    if(!isFinite(expMs)) return true;

    if(Date.now() > expMs){
      showMsg("Subscription expired. Contact your coach.", false);
      await signOut(auth);
      return false;
    }
    return true;
  }

  onAuthStateChanged(auth, async (user)=>{
    if(user){
      el("conn").textContent = "Firebase: CONNECTED";
      el("logoutBtn").disabled = false;
      el("sessEmail").textContent = user.email || "—";
      el("sessUid").textContent = "UID: " + user.uid;

      let profile = null;
      try{
        const snap = await getDoc(doc(db, "users", user.uid));
        profile = snap.exists() ? snap.data() : null;
      }catch(e){
        el("sessRole").textContent = "ROLE: —";
        el("sessSub").textContent = "SUB: —";
        showMsg(`Firestore read blocked: ${e.code || ""} ${e.message || e}`);
        return;
      }

      // subscription gate
      const ok = await checkSubscriptionOrSignOut(profile);
      if(!ok) return;

      const role = profile?.role || "unknown";
      el("sessRole").textContent = "ROLE: " + role;

      if(role === "subscriber" && profile?.subExpiresAt){
        const expMs = profile.subExpiresAt.toMillis();
        el("sessSub").textContent = "SUB: exp " + fmtDate(expMs);
      } else {
        el("sessSub").textContent = "SUB: —";
      }

      // dashboard
      el("dashText").textContent = `Welcome ${profile?.name || ""} — your role is ${role}.`;

      // panels
      el("coachPanel").classList.toggle("hidden", !(role==="coach" || role==="admin"));
      el("adminPanel").classList.toggle("hidden", role!=="admin");

      // show app
      el("authCard").classList.add("hidden");
      el("appCard").classList.remove("hidden");
    } else {
      el("conn").textContent = "Firebase: —";
      el("logoutBtn").disabled = true;
      el("sessEmail").textContent = "—";
      el("sessRole").textContent = "ROLE: —";
      el("sessUid").textContent = "UID: —";
      el("sessSub").textContent = "SUB: —";
      el("authCard").classList.remove("hidden");
      el("appCard").classList.add("hidden");
    }
  });
</script>
</body>
</html>
