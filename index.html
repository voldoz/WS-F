<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>WS Fitness</title>
  <style>
    :root{
      --bg1:#0f172a; --bg2:#111827; --card:#111c2f; --card2:#0b1220;
      --ink:#e5e7eb; --muted:#94a3b8; --line:#23314b;
      --blue:#38bdf8; --blue2:#2563eb; --good:#22c55e; --bad:#ef4444;
      --pill:#0b1220;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:18px; color:var(--ink);
      font-family: Arial, sans-serif;
      background:
        radial-gradient(1200px 800px at 20% 10%, #0b3b6a22, transparent 60%),
        radial-gradient(1200px 800px at 90% 30%, #2563eb22, transparent 55%),
        linear-gradient(135deg,var(--bg1),var(--bg2));
    }
    .wrap{max-width:980px;margin:0 auto}
    h1{margin:0 0 14px; text-align:center; color:var(--blue); letter-spacing:.4px}
    .card{
      background: rgba(17,28,47,.86);
      border:1px solid rgba(35,49,75,.75);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 14px 40px rgba(0,0,0,.25);
      backdrop-filter: blur(8px);
      margin-bottom:12px;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .col{flex:1; min-width:220px}
    label{display:block; margin:10px 0 6px; font-weight:900}
    input,select,textarea{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(35,49,75,.95);
      background:var(--card2);
      color:var(--ink);
      outline:none;
      font-size:15px;
    }
    input::placeholder, textarea::placeholder{color:#64748b}
    button{
      width:100%;
      padding:13px 14px;
      border-radius:14px;
      border:0;
      background: linear-gradient(90deg,var(--blue),var(--blue2));
      color:white;
      font-weight:900;
      font-size:16px;
      cursor:pointer;
      margin-top:10px;
    }
    button.secondary{
      background:var(--card2);
      border:1px solid rgba(35,49,75,.95);
      color:var(--ink);
    }
    button.danger{ background: var(--bad); }
    .pill{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      background:var(--pill);
      border:1px solid rgba(35,49,75,.95);
      border-radius:14px; padding:10px 12px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px; border-radius:999px;
      background:var(--card2);
      border:1px solid rgba(35,49,75,.95);
      color:var(--muted);
      font-weight:900; font-size:12px
    }
    .msg{
      margin-top:10px; padding:10px 12px; border-radius:12px;
      border:1px solid rgba(35,49,75,.95); background:var(--card2)
    }
    .msg.ok{color:#bbf7d0}
    .msg.err{color:#fecaca}
    .hidden{display:none !important}
    .hr{height:1px;background:rgba(35,49,75,.95);margin:12px 0;border-radius:999px}
    .tabs{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .tab{
      flex:1; min-width:150px;
      border:1px solid rgba(35,49,75,.95);
      background:var(--card2);
      color:var(--ink);
      border-radius:12px;
      padding:12px;
      font-weight:900;
      cursor:pointer;
    }
    .tab.active{background:linear-gradient(90deg,var(--blue),var(--blue2)); border:0}
    .muted{color:var(--muted); font-size:13px; line-height:1.6}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace}
    .scroll{
      max-height: 420px;
      overflow:auto;
      padding-right:6px;
      scrollbar-gutter: stable;
    }
    .scroll::-webkit-scrollbar{ width:10px; }
    .scroll::-webkit-scrollbar-track{ background: rgba(148,163,184,.12); border-radius:999px; }
    .scroll::-webkit-scrollbar-thumb{
      background: linear-gradient(180deg, rgba(56,189,248,.65), rgba(37,99,235,.65));
      border-radius:999px;
      border:2px solid rgba(15,23,42,.9);
    }
    .scroll::-webkit-scrollbar-thumb:hover{
      background: linear-gradient(180deg, rgba(56,189,248,.85), rgba(37,99,235,.85));
    }
    details{
      background: rgba(11,18,32,.55);
      border:1px solid rgba(35,49,75,.8);
      border-radius:14px;
      padding:10px 12px;
      margin-top:10px;
    }
    summary{cursor:pointer; font-weight:900}
    .work-row{
      display:grid;
      grid-template-columns: 1fr auto auto auto;
      gap:8px;
      align-items:center;
      background:var(--card2);
      border:1px solid rgba(35,49,75,.95);
      border-radius:12px;
      padding:10px;
      margin-top:8px;
    }
    .btn-mini{
      width:auto;
      padding:10px 12px;
      border-radius:12px;
      margin:0;
      font-weight:900;
      font-size:13px;
      background:var(--card2);
      border:1px solid rgba(35,49,75,.95);
      color:var(--ink);
    }
    .btn-mini.primary{
      background:linear-gradient(90deg,var(--blue),var(--blue2));
      border:0;
      color:#fff;
    }
    @media (max-width:760px){
      .work-row{ grid-template-columns: 1fr auto auto; }
      .work-row .del{ grid-column: 1/-1; }
    }
  </style>
</head>

<body>
<div class="wrap">
  <h1>WS Fitness</h1>

  <!-- STATUS -->
  <div class="card">
    <div class="pill">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <span class="badge">Session: <b id="sessName">—</b></span>
        <span class="badge" id="sessRole">ROLE: —</span>
        <span class="badge hidden" id="sessUid">UID: —</span>
        <span class="badge hidden" id="sessSub">SUB: —</span>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <span class="badge" id="conn">Firebase: —</span>
        <button class="secondary" style="width:auto;margin:0;padding:10px 12px" id="logoutBtn" onclick="logout()" disabled>Logout</button>
      </div>
    </div>
    <div class="muted" style="margin-top:10px">
      نفس ستايل ws-fitness + Firebase Auth/Firestore • Name + PIN فقط
    </div>
  </div>

  <!-- AUTH -->
  <div class="card" id="authCard">
    <div class="tabs">
      <button class="tab active" id="tabLogin" onclick="setAuthMode('login')">Login</button>
      <button class="tab" id="tabUser" onclick="setAuthMode('user')">Create Account</button>
      <button class="tab" id="tabCoach" onclick="setAuthMode('coach')">Create Coach</button>
    </div>

    <div id="panelLogin">
      <div class="row">
        <div class="col">
          <label>Name</label>
          <input id="loginName" placeholder="مثال: Waleed" autocomplete="username">
        </div>
        <div class="col">
          <label>PIN (6 digits)</label>
          <input id="loginPin" type="password" inputmode="numeric" maxlength="6" placeholder="******" autocomplete="current-password">
        </div>
      </div>
      <button onclick="login()">Login</button>
    </div>

    <div id="panelUser" class="hidden">
      <div class="row">
        <div class="col">
          <label>Name</label>
          <input id="userName" placeholder="Name" autocomplete="username">
        </div>
        <div class="col">
          <label>PIN (6 digits)</label>
          <input id="userPin" type="password" inputmode="numeric" maxlength="6" placeholder="******" autocomplete="new-password">
        </div>
      </div>
      <button onclick="createAccount('user')">Create Account</button>
      <div class="muted">ملاحظة: الأيميل مخفي داخليًا (Firebase Auth) وما يطلع للمستخدم.</div>
    </div>

    <div id="panelCoach" class="hidden">
      <div class="row">
        <div class="col">
          <label>Name</label>
          <input id="coachName" placeholder="Coach name" autocomplete="username">
        </div>
        <div class="col">
          <label>PIN (6 digits)</label>
          <input id="coachPin" type="password" inputmode="numeric" maxlength="6" placeholder="******" autocomplete="new-password">
        </div>
      </div>
      <button onclick="createAccount('coach')">Create Coach</button>
    </div>

    <div id="msg" class="msg hidden"></div>
  </div>

  <!-- APP -->
  <div class="card hidden" id="appCard">
    <div class="tabs" id="appTabs">
      <button class="tab active" id="tProfile" onclick="setAppTab('profile')">Profile</button>
      <button class="tab" id="tAdmin" onclick="setAppTab('admin')">Admin</button>
      <button class="tab" id="tCoach" onclick="setAppTab('coach')">Coach</button>
      <button class="tab" id="tCalculator" onclick="setAppTab('calculator')">Calculator</button>
      <button class="tab" id="tWorkouts" onclick="setAppTab('workouts')">Workouts</button>
      <button class="tab" id="tBurn" onclick="setAppTab('burn')">Daily Burn</button>
      <button class="tab" id="tWeight" onclick="setAppTab('weight')">Weight</button>
    </div>

    <div class="hr"></div>

    <!-- PROFILE -->
    <div id="pageProfile">
      <div class="row">
        <div class="col">
          <label>Name</label>
          <input id="pName" placeholder="Name">
        </div>
        <div class="col">
          <label>Role</label>
          <input id="pRole" disabled>
        </div>
      </div>

      <div id="subBox" class="msg hidden">
        <div style="font-weight:900;margin-bottom:6px">Subscription</div>
        <div id="subInfo" class="muted">—</div>
      </div>

      <div class="row">
        <div class="col">
          <label>Change PIN (6 digits)</label>
          <input id="newPin" type="password" inputmode="numeric" maxlength="6" placeholder="******">
          <button class="secondary" onclick="changePin()">Change PIN</button>
        </div>
      </div>

      <button onclick="saveProfile()">Save Profile</button>
    </div>

    <!-- ADMIN -->
    <div id="pageAdmin" class="hidden">
      <div class="msg">
        <b>Admin Notes</b>
        <div class="muted">
          - الأدمن فقط يشوف UID<br>
          - لا يوجد حذف حقيقي لحسابات Auth من داخل الفرونت (يحتاج Backend).<br>
          - بدل الحذف: نعطل الحساب (disabled=true) ويمنع الدخول.
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>List Coaches</label>
          <button class="secondary" onclick="adminLoadCoaches()">Load Coaches</button>
          <div class="scroll" id="adminCoachList"></div>
        </div>
        <div class="col">
          <label>Disable Account by UID</label>
          <input id="adminDisableUid" class="mono" placeholder="paste UID">
          <button class="danger" onclick="adminDisable()">Disable</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <div class="col">
          <label>Reset ALL Firestore Data (admin only)</label>
          <button class="danger" onclick="adminWipeAll()">WIPE ALL DATA</button>
        </div>
      </div>
      <div class="muted small">يمسح بيانات Firestore فقط (الـ Auth users يبقون لكن يمكن تعطيلهم).</div>
    </div>

    <!-- COACH -->
    <div id="pageCoach" class="hidden">
      <div class="row">
        <div class="col">
          <label>Create Subscriber</label>
          <input id="subName" placeholder="Subscriber name">
          <input id="subPin" type="password" inputmode="numeric" maxlength="6" placeholder="PIN (6 digits)">
          <label>Subscription Duration</label>
          <select id="subMonths">
            <option value="1">1 month</option><option value="2">2 months</option><option value="3">3 months</option>
            <option value="4">4 months</option><option value="5">5 months</option><option value="6">6 months</option>
          </select>
          <button onclick="coachCreateSubscriber()">Create Subscriber</button>
        </div>

        <div class="col">
          <label>My Subscribers</label>
          <select id="coachTarget" onchange="onCoachTargetChange()"></select>
          <div class="msg" id="coachSubInfo">—</div>
          <label>Extend Subscription</label>
          <select id="extendMonths">
            <option value="1">+1 month</option><option value="2">+2 months</option><option value="3">+3 months</option>
            <option value="4">+4 months</option><option value="5">+5 months</option><option value="6">+6 months</option>
          </select>
          <button class="secondary" onclick="coachExtendSub()">Extend</button>

          <button class="danger" onclick="coachDisableSubscriber()">Disable Subscriber</button>
        </div>
      </div>

      <div class="muted">بعد اختيار مشترك من القائمة، صفحات Calculator/Workouts/Burn/Weight تتحكم ببياناته.</div>
    </div>

    <!-- CALCULATOR -->
    <div id="pageCalculator" class="hidden">
      <div class="row">
        <div class="col">
          <label>Weight (kg)</label>
          <select id="cWeight"></select>
        </div>
        <div class="col">
          <label>Height (cm)</label>
          <select id="cHeight"></select>
        </div>
        <div class="col">
          <label>Age</label>
          <select id="cAge"></select>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Gender</label>
          <select id="cGender">
            <option value="male">Male</option>
            <option value="female">Female</option>
          </select>
        </div>
        <div class="col">
          <label>Activity Days</label>
          <select id="cDays">
            <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
          </select>
        </div>
        <div class="col">
          <label>Goal</label>
          <select id="cGoal">
            <option value="cut">Cut</option>
            <option value="maintain">Maintain</option>
            <option value="bulk">Bulk</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Protein Multiplier</label>
          <select id="cProtMult">
            <option value="1.5">1.5</option>
            <option value="1.8">1.8</option>
            <option value="2.0" selected>2.0</option>
            <option value="2.2">2.2</option>
            <option value="2.5">2.5</option>
            <option value="2.8">2.8</option>
            <option value="3.0">3.0</option>
          </select>
        </div>
        <div class="col">
          <label>Meals</label>
          <select id="cMeals">
            <option>2</option><option>3</option><option selected>4</option><option>5</option><option>6</option>
          </select>
        </div>
        <div class="col">
          <label>Weekly Goal</label>
          <select id="cWeekly">
            <option value="0.5">0.5 kg</option>
            <option value="1.0" selected>1 kg</option>
            <option value="1.5">1.5 kg</option>
            <option value="2.0">2 kg</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Density (Preset)</label>
          <select id="cDensityPreset" onchange="applyDensityPreset()">
            <option value="custom">Custom</option>
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
          </select>
        </div>
        <div class="col">
          <label>Protein Density (g per 100g)</label>
          <select id="cPDens">
            <option>18</option><option selected>20</option><option>25</option><option>30</option><option>35</option>
          </select>
        </div>
        <div class="col">
          <label>Carb Density (g per 100g)</label>
          <select id="cCDens">
            <option>15</option><option selected>20</option><option>25</option><option>30</option><option>35</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Fat Density (g per 100g)</label>
          <select id="cFDens">
            <option>50</option><option selected>80</option><option>100</option>
          </select>
        </div>
      </div>

      <button onclick="calcNow()">Calculate & Save</button>

      <div class="hr"></div>

      <div class="scroll">
        <div class="msg ok hidden" id="calcOut"></div>
        <div class="msg hidden" id="mealOut"></div>
      </div>
    </div>

    <!-- WORKOUTS -->
    <div id="pageWorkouts" class="hidden">
      <div class="muted">Sunday → Saturday</div>
      <div class="scroll" id="workScroll"></div>
      <button class="secondary" onclick="saveWorkouts()">Save Workouts</button>
      <button class="secondary" onclick="resetWorkouts()">Reset workouts</button>
    </div>

    <!-- BURN -->
    <div id="pageBurn" class="hidden">
      <div class="row">
        <div class="col">
          <label>Burned Today (kcal)</label>
          <input id="burnToday" type="number" min="0" placeholder="e.g. 500">
          <button onclick="saveBurnToday()">Update</button>
          <button class="secondary" onclick="resetBurn()">Reset logs</button>
        </div>
        <div class="col">
          <label>Weekly burn target</label>
          <input id="burnWeeklyTarget" disabled>
          <div class="msg" id="burnSummary">—</div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="scroll" id="burnList"></div>
    </div>

    <!-- WEIGHT -->
    <div id="pageWeight" class="hidden">
      <div class="row">
        <div class="col">
          <label>Weekly Weight (kg)</label>
          <input id="wValue" type="number" min="0" step="0.1" placeholder="e.g. 95.2">
        </div>
        <div class="col">
          <label>Week Date</label>
          <input id="wDate" type="date">
        </div>
      </div>
      <button onclick="saveWeight()">Save</button>
      <button class="secondary" onclick="resetWeight()">Reset weight log</button>
      <div class="hr"></div>
      <div class="scroll" id="weightList"></div>
    </div>

  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
    signOut, onAuthStateChanged, updatePassword
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp,
    Timestamp, collection, query, where, getDocs, orderBy, limit,
    writeBatch
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ✅ ضع إعدادات Firebase الخاصة بك هنا
  const firebaseConfig = {
    apiKey: "AIzaSyAK06AL_e24OQuoWvNmp9I6Xkc2Yx9ZoBc",
    authDomain: "ws-fitness.firebaseapp.com",
    projectId: "ws-fitness",
    storageBucket: "ws-fitness.firebasestorage.app",
    messagingSenderId: "639434705944",
    appId: "1:639434705944:web:4f0eef88b76e4d856c076d",
    measurementId: "G-BZG7GS5ZDW"
  };

  // primary app
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // secondary app (to create subscribers without kicking current coach out)
  const app2 = initializeApp(firebaseConfig, "secondary");
  const auth2 = getAuth(app2);

  const el = (id)=>document.getElementById(id);
  const msgBox = el("msg");

  let currentProfile = null;
  let activeTab = "profile";
  let coachTargetUid = null; // if coach selects a subscriber, edits apply to subscriber

  function showMsg(text, ok=false){
    msgBox.classList.remove("hidden","ok","err");
    msgBox.classList.add(ok ? "ok" : "err");
    msgBox.textContent = text;
  }
  function clearMsg(){ msgBox.classList.add("hidden"); msgBox.textContent=""; }

  function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

  function cleanName(name){
    return String(name||"").trim().toLowerCase().replace(/\s+/g,"_");
  }
  function validPin(pin){
    return /^[0-9]{6}$/.test(String(pin||""));
  }
  function hiddenEmailFromName(name){
    // Email داخلي مخفي (المستخدم ما يشوفه)
    const key = cleanName(name);
    return `${key}@ws-fitness.local`;
  }

  function effectiveUid(){
    const role = currentProfile?.role;
    if(role === "coach" && coachTargetUid) return coachTargetUid;
    return auth.currentUser?.uid || null;
  }

  // ---------- AUTH UI ----------
  window.setAuthMode = (mode)=>{
    clearMsg();
    el("tabLogin").classList.toggle("active", mode==="login");
    el("tabUser").classList.toggle("active", mode==="user");
    el("tabCoach").classList.toggle("active", mode==="coach");

    el("panelLogin").classList.toggle("hidden", mode!=="login");
    el("panelUser").classList.toggle("hidden", mode!=="user");
    el("panelCoach").classList.toggle("hidden", mode!=="coach");
  };

  // ---------- APP TABS ----------
  window.setAppTab = async (tab)=>{
    activeTab = tab;

    const tabs = ["profile","admin","coach","calculator","workouts","burn","weight"];
    for(const t of tabs){
      const b = el("t"+cap(t));
      const p = el("page"+cap(t));
      if(b) b.classList.toggle("active", t===tab);
      if(p) p.classList.toggle("hidden", t!==tab);
    }

    if(tab==="coach") await loadCoachSubscribers();
    if(tab==="calculator") await loadCalc();
    if(tab==="workouts") await loadWorkouts();
    if(tab==="burn") await loadBurnWeek();
    if(tab==="weight") await loadWeights();
  };

  // ---------- LOGIN / CREATE ----------
  window.login = async ()=>{
    clearMsg();
    const name = el("loginName").value;
    const pin = el("loginPin").value;
    if(!name || !validPin(pin)) return showMsg("اكتب Name + PIN (6 digits).");

    const email = hiddenEmailFromName(name);

    try{
      await signInWithEmailAndPassword(auth, email, pin);
      showMsg("Logged in ✅", true);
    }catch(e){
      showMsg(`Login error: ${e.code||""} ${e.message||e}`);
    }
  };

  window.createAccount = async (role)=>{
    clearMsg();
    const name = (role==="coach" ? el("coachName").value : el("userName").value);
    const pin  = (role==="coach" ? el("coachPin").value  : el("userPin").value);
    if(!name || !validPin(pin)) return showMsg("اكتب Name + PIN (6 digits).");

    const email = hiddenEmailFromName(name);

    try{
      const cred = await createUserWithEmailAndPassword(auth, email, pin);
      const uid = cred.user.uid;

      await setDoc(doc(db,"users",uid),{
        name: String(name).trim(),
        nameKey: cleanName(name),
        role,           // user | coach
        disabled: false,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      },{merge:true});

      showMsg(`Created ${role.toUpperCase()} ✅`, true);
    }catch(e){
      showMsg(`Create error: ${e.code||""} ${e.message||e}`);
    }
  };

  window.logout = async ()=>{
    clearMsg();
    await signOut(auth);
  };

  // ---------- PROFILE ----------
  window.saveProfile = async ()=>{
    clearMsg();
    const uid = auth.currentUser?.uid;
    if(!uid) return showMsg("Login first.");
    try{
      await updateDoc(doc(db,"users",uid),{
        name: (el("pName").value||"").trim(),
        updatedAt: serverTimestamp()
      });
      showMsg("Saved ✅", true);
    }catch(e){
      showMsg(`Save error: ${e.code||""} ${e.message||e}`);
    }
  };

  window.changePin = async ()=>{
    clearMsg();
    const pin = (el("newPin").value||"").trim();
    if(!validPin(pin)) return showMsg("PIN لازم 6 أرقام.");
    try{
      await updatePassword(auth.currentUser, pin);
      el("newPin").value = "";
      showMsg("PIN changed ✅", true);
    }catch(e){
      showMsg(`PIN error: ${e.code||""} ${e.message||e}`);
    }
  };

  // ---------- COACH: CREATE SUBSCRIBER (SECONDARY AUTH) ----------
  function addMonthsMillis(startMs, months){
    const d = new Date(startMs);
    const day = d.getDate();
    d.setMonth(d.getMonth()+months);
    if(d.getDate() < day) d.setDate(0);
    return d.getTime();
  }
  function formatDate(ms){
    const d=new Date(ms);
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    const da=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }

  window.coachCreateSubscriber = async ()=>{
    clearMsg();
    if(currentProfile?.role !== "coach" && currentProfile?.role !== "admin") return showMsg("Coach/Admin only.");

    const name = (el("subName").value||"").trim();
    const pin  = (el("subPin").value||"").trim();
    const months = Number(el("subMonths").value||"1");

    if(!name || !validPin(pin)) return showMsg("Subscriber: Name + PIN (6 digits).");

    const email = hiddenEmailFromName(name);
    try{
      // create auth user without switching coach session:
      const cred = await createUserWithEmailAndPassword(auth2, email, pin);
      const subUid = cred.user.uid;

      const now = Date.now();
      const expMs = addMonthsMillis(now, Math.max(1, Math.min(6, months)));

      await setDoc(doc(db,"users",subUid),{
        name,
        nameKey: cleanName(name),
        role: "subscriber",
        coachId: auth.currentUser.uid,
        disabled: false,
        subStartAt: Timestamp.fromMillis(now),
        subExpiresAt: Timestamp.fromMillis(expMs),
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      },{merge:true});

      await signOut(auth2); // cleanup secondary auth
      el("subName").value=""; el("subPin").value="";
      showMsg("Subscriber created ✅", true);
      await loadCoachSubscribers();
    }catch(e){
      showMsg(`Create subscriber error: ${e.code||""} ${e.message||e}`);
      try{ await signOut(auth2);}catch{}
    }
  };

  window.onCoachTargetChange = async ()=>{
    coachTargetUid = el("coachTarget").value || null;
    await refreshCoachTargetInfo();
    if(activeTab==="calculator") await loadCalc();
    if(activeTab==="workouts") await loadWorkouts();
    if(activeTab==="burn") await loadBurnWeek();
    if(activeTab==="weight") await loadWeights();
  };

  async function refreshCoachTargetInfo(){
    const uid = coachTargetUid;
    if(!uid){ el("coachSubInfo").textContent = "—"; return; }
    const snap = await getDoc(doc(db,"users",uid));
    if(!snap.exists()){ el("coachSubInfo").textContent="—"; return; }
    const d = snap.data();
    const expMs = d.subExpiresAt?.toMillis?.() || null;
    const startMs = d.subStartAt?.toMillis?.() || null;
    const daysLeft = expMs ? Math.ceil((expMs - Date.now())/(24*60*60*1000)) : null;

    el("coachSubInfo").innerHTML =
      `<b>${escapeHtml(d.name||"")}</b><div class="muted">
        Start: <b>${startMs ? formatDate(startMs) : "—"}</b><br>
        Expiry: <b>${expMs ? formatDate(expMs) : "—"}</b><br>
        Days left: <b>${daysLeft ?? "—"}</b>
      </div>`;
  }

  window.coachExtendSub = async ()=>{
    clearMsg();
    if(currentProfile?.role !== "coach" && currentProfile?.role !== "admin") return showMsg("Coach/Admin only.");
    if(!coachTargetUid) return showMsg("اختر مشترك.");
    const addM = Number(el("extendMonths").value||"1");
    try{
      const ref = doc(db,"users",coachTargetUid);
      const snap = await getDoc(ref);
      if(!snap.exists()) return showMsg("Subscriber not found.");
      const d = snap.data();
      const oldExp = d.subExpiresAt?.toMillis?.() || Date.now();
      const newExp = addMonthsMillis(oldExp, Math.max(1, Math.min(6, addM)));
      await updateDoc(ref, { subExpiresAt: Timestamp.fromMillis(newExp), updatedAt: serverTimestamp() });
      showMsg("Extended ✅", true);
      await refreshCoachTargetInfo();
      await loadCoachSubscribers();
    }catch(e){
      showMsg(`Extend error: ${e.code||""} ${e.message||e}`);
    }
  };

  window.coachDisableSubscriber = async ()=>{
    clearMsg();
    if(currentProfile?.role !== "coach" && currentProfile?.role !== "admin") return showMsg("Coach/Admin only.");
    if(!coachTargetUid) return showMsg("اختر مشترك.");
    try{
      await updateDoc(doc(db,"users",coachTargetUid),{ disabled:true, updatedAt: serverTimestamp() });
      showMsg("Subscriber disabled ✅", true);
      coachTargetUid = null;
      await loadCoachSubscribers();
    }catch(e){
      showMsg(`Disable error: ${e.code||""} ${e.message||e}`);
    }
  };

  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  // ✅ Fix “coach cannot see subscribers”:
  // Query by coachId only (no composite index needed)
  async function loadCoachSubscribers(){
    if(currentProfile?.role !== "coach" && currentProfile?.role !== "admin") return;

    const sel = el("coachTarget");
    sel.innerHTML = `<option value="">Select Subscriber</option>`;

    const qy = query(collection(db,"users"), where("coachId","==", auth.currentUser.uid), orderBy("createdAt","desc"), limit(200));
    const snaps = await getDocs(qy);

    let found = 0;
    snaps.forEach(s=>{
      const d = s.data();
      if(d?.role === "subscriber"){
        found++;
        const opt = document.createElement("option");
        opt.value = s.id;
        opt.textContent = d.name || (s.id.slice(0,6)+"…");
        sel.appendChild(opt);
      }
    });

    if(coachTargetUid){
      sel.value = coachTargetUid;
    }
    await refreshCoachTargetInfo();

    if(found===0){
      el("coachSubInfo").innerHTML = `<div class="muted">No subscribers yet.</div>`;
    }
  }

  // ---------- CALCULATOR ----------
  function fillSelectRange(selId, start, end){
    const s = el(selId);
    s.innerHTML = "";
    for(let i=start; i<=end; i++){
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = String(i);
      s.appendChild(opt);
    }
  }

  function calcBMR(w,h,a,gender){
    // Mifflin St Jeor
    if(gender==="male") return (10*w) + (6.25*h) - (5*a) + 5;
    return (10*w) + (6.25*h) - (5*a) - 161;
  }
  function activityFactor(days){
    const map = {1:1.35,2:1.42,3:1.50,4:1.58,5:1.65,6:1.72};
    return map[days] || 1.5;
  }

  window.applyDensityPreset = ()=>{
    const p = el("cDensityPreset").value;
    if(p==="low"){ el("cPDens").value="18"; el("cCDens").value="15"; el("cFDens").value="50"; }
    if(p==="medium"){ el("cPDens").value="20"; el("cCDens").value="20"; el("cFDens").value="80"; }
    if(p==="high"){ el("cPDens").value="30"; el("cCDens").value="30"; el("cFDens").value="100"; }
  };

  function goalAdjust(goal){
    // simple adjustment
    if(goal==="bulk") return +250;
    if(goal==="cut") return -250;
    return 0;
  }

  window.calcNow = async ()=>{
    clearMsg();
    const uid = effectiveUid();
    if(!uid) return showMsg("Login first.");

    const w = Number(el("cWeight").value);
    const h = Number(el("cHeight").value);
    const a = Number(el("cAge").value);
    const gender = el("cGender").value;
    const days = Number(el("cDays").value);
    const goal = el("cGoal").value;
    const pm = Number(el("cProtMult").value);
    const meals = Number(el("cMeals").value);
    const weekly = Number(el("cWeekly").value);

    const pDens = Number(el("cPDens").value); // g per 100g
    const cDens = Number(el("cCDens").value);
    const fDens = Number(el("cFDens").value);

    const bmr = calcBMR(w,h,a,gender);
    const tdee = bmr * activityFactor(days);

    const dailyDeficit = (weekly * 7700) / 7; // burn target
    let targetCalories = Math.round(tdee - dailyDeficit + goalAdjust(goal));
    targetCalories = Math.max(1200, targetCalories);

    const proteinG = Math.round(w * pm);
    const fatG = Math.round(w * 0.8);
    const proteinK = proteinG * 4;
    const fatK = fatG * 9;
    const remainingK = Math.max(0, targetCalories - proteinK - fatK);
    const carbsG = Math.round(remainingK / 4);

    // ✅ Fix "Per Meal on scale": integers + stable
    const pMeal = Math.max(0, Math.round(proteinG / meals));
    const cMeal = Math.max(0, Math.round(carbsG / meals));
    const fMeal = Math.max(0, Math.round(fatG / meals));

    // Scale grams based on density (g macro per 100g food)
    const scaleP = pDens > 0 ? Math.round((pMeal / pDens) * 100) : 0;
    const scaleC = cDens > 0 ? Math.round((cMeal / cDens) * 100) : 0;
    const scaleF = fDens > 0 ? Math.round((fMeal / fDens) * 100) : 0;

    // render
    el("calcOut").classList.remove("hidden");
    el("calcOut").innerHTML =
      `<div style="font-weight:900;margin-bottom:6px">Results</div>
       <div class="muted">
        BMR: <b>${Math.round(bmr)}</b> kcal<br>
        TDEE: <b>${Math.round(tdee)}</b> kcal<br>
        Daily Calories: <b>${targetCalories}</b> kcal/day
       </div>
       <div class="hr"></div>
       <div class="muted">
        Protein/Carbs/Fat: <b>${proteinG}</b>g / <b>${carbsG}</b>g / <b>${fatG}</b>g
       </div>`;

    el("mealOut").classList.remove("hidden");
    el("mealOut").innerHTML =
      `<div style="font-weight:900;margin-bottom:6px">Per Meal (Macros + Scale)</div>
       <div class="muted">
        Meals: <b>${meals}</b><br>
        Macros/meal: <b>${pMeal}</b>g P • <b>${cMeal}</b>g C • <b>${fMeal}</b>g F
       </div>
       <div class="hr"></div>
       <div class="muted">
        Scale grams (based on density):<br>
        Protein item: <b>${scaleP}</b> g<br>
        Carb item: <b>${scaleC}</b> g<br>
        Fat item: <b>${scaleF}</b> g
       </div>`;

    const payload = {
      w,h,a,gender,days,goal,pm,meals,weekly,
      pDens,cDens,fDens,
      bmr,tdee,targetCalories,
      dailyDeficit,
      proteinG,carbsG,fatG,
      pMeal,cMeal,fMeal,
      scaleP,scaleC,scaleF,
      updatedAt: serverTimestamp()
    };

    try{
      await setDoc(doc(db,"users",uid,"calculator","current"), payload, {merge:true});
      showMsg("Saved ✅", true);
    }catch(e){
      showMsg(`Save calc error: ${e.code||""} ${e.message||e}`);
    }
  };

  async function loadCalc(){
    const uid = effectiveUid();
    if(!uid) return;

    const snap = await getDoc(doc(db,"users",uid,"calculator","current"));
    if(!snap.exists()){
      el("calcOut").classList.add("hidden");
      el("mealOut").classList.add("hidden");
      return;
    }
    const d = snap.data();

    // ✅ Fallback: if per-meal missing in older docs, compute
    if((d.pMeal===undefined || d.cMeal===undefined || d.fMeal===undefined) && d.meals){
      const meals = Math.max(1, Number(d.meals||1));
      d.pMeal = Math.max(0, Math.round(Number(d.proteinG||0)/meals));
      d.cMeal = Math.max(0, Math.round(Number(d.carbsG||0)/meals));
      d.fMeal = Math.max(0, Math.round(Number(d.fatG||0)/meals));
      const pDens = Number(d.pDens||20), cDens = Number(d.cDens||20), fDens = Number(d.fDens||80);
      d.scaleP = pDens>0 ? Math.round((d.pMeal/pDens)*100) : 0;
      d.scaleC = cDens>0 ? Math.round((d.cMeal/cDens)*100) : 0;
      d.scaleF = fDens>0 ? Math.round((d.fMeal/fDens)*100) : 0;
    }

    // set inputs (best-effort)
    safeSet("cWeight", d.w);
    safeSet("cHeight", d.h);
    safeSet("cAge", d.a);
    safeSet("cGender", d.gender);
    safeSet("cDays", d.days);
    safeSet("cGoal", d.goal);
    safeSet("cProtMult", d.pm);
    safeSet("cMeals", d.meals);
    safeSet("cWeekly", d.weekly);
    safeSet("cPDens", d.pDens);
    safeSet("cCDens", d.cDens);
    safeSet("cFDens", d.fDens);

    el("calcOut").classList.remove("hidden");
    el("mealOut").classList.remove("hidden");

    el("calcOut").innerHTML =
      `<div style="font-weight:900;margin-bottom:6px">Saved Results</div>
       <div class="muted">
        Daily Calories: <b>${d.targetCalories}</b> kcal/day<br>
        Daily Burn Target: <b>${Math.round(d.dailyDeficit||0)}</b> kcal/day
       </div>
       <div class="hr"></div>
       <div class="muted">
        Protein/Carbs/Fat: <b>${d.proteinG}</b>g / <b>${d.carbsG}</b>g / <b>${d.fatG}</b>g
       </div>`;

    el("mealOut").innerHTML =
      `<div style="font-weight:900;margin-bottom:6px">Per Meal (Macros + Scale)</div>
       <div class="muted">
        Meals: <b>${d.meals}</b><br>
        Macros/meal: <b>${d.pMeal}</b>g P • <b>${d.cMeal}</b>g C • <b>${d.fMeal}</b>g F
       </div>
       <div class="hr"></div>
       <div class="muted">
        Protein item: <b>${d.scaleP||0}</b> g<br>
        Carb item: <b>${d.scaleC||0}</b> g<br>
        Fat item: <b>${d.scaleF||0}</b> g
       </div>`;
  }

  function safeSet(id, val){
    const s = el(id);
    if(!s || val===undefined || val===null) return;
    const v = String(val);
    for(const opt of s.options){
      if(opt.value === v){ s.value = v; return; }
    }
  }

  // ---------- WORKOUTS ----------
  const weekDays = [
    {key:"sunday", label:"Sunday"},
    {key:"monday", label:"Monday"},
    {key:"tuesday", label:"Tuesday"},
    {key:"wednesday", label:"Wednesday"},
    {key:"thursday", label:"Thursday"},
    {key:"friday", label:"Friday"},
    {key:"saturday", label:"Saturday"},
  ];
  function emptyPlan(){ const o={}; for(const d of weekDays) o[d.key]=[]; return o; }

  function renderWorkRow(day, idx, item){
    const row = document.createElement("div");
    row.className = "work-row";

    const name = document.createElement("input");
    name.placeholder = "Exercise";
    name.value = item?.name || "";
    name.oninput = ()=> item.name = name.value;

    const setsBtn = document.createElement("button");
    setsBtn.className = "btn-mini primary";
    setsBtn.textContent = `Sets: ${item?.sets ?? 3}`;
    setsBtn.onclick = ()=>{
      item.sets = Math.max(1, Math.min(30, (item.sets||3)+1));
      setsBtn.textContent = `Sets: ${item.sets}`;
    };

    const maxBtn = document.createElement("button");
    maxBtn.className = "btn-mini";
    maxBtn.textContent = `Max: ${item?.maxKg ?? 0} kg`;
    maxBtn.onclick = ()=>{
      const v = prompt("Max weight (kg):", String(item.maxKg ?? 0));
      if(v===null) return;
      const n = Math.max(0, Math.min(500, Number(v)||0));
      item.maxKg = n;
      maxBtn.textContent = `Max: ${item.maxKg} kg`;
    };

    const del = document.createElement("button");
    del.className = "btn-mini del";
    del.textContent = "✕";
    del.onclick = ()=>{
      window.__workPlan[day].splice(idx,1);
      renderWorkoutUI(window.__workPlan);
    };

    row.appendChild(name);
    row.appendChild(setsBtn);
    row.appendChild(maxBtn);
    row.appendChild(del);
    return row;
  }

  function renderWorkoutUI(plan){
    const wrap = el("workScroll");
    wrap.innerHTML = "";
    for(const d of weekDays){
      const det = document.createElement("details");
      det.open = false;

      const sum = document.createElement("summary");
      sum.textContent = d.label;
      det.appendChild(sum);

      const list = document.createElement("div");
      const items = plan?.[d.key] || [];
      for(let i=0;i<items.length;i++){
        list.appendChild(renderWorkRow(d.key, i, items[i]));
      }

      const addBtn = document.createElement("button");
      addBtn.className = "secondary";
      addBtn.textContent = "Add Exercise";
      addBtn.onclick = ()=>{
        plan[d.key].push({name:"", sets:3, maxKg:0});
        renderWorkoutUI(plan);
      };

      det.appendChild(list);
      det.appendChild(addBtn);
      wrap.appendChild(det);
    }
  }

  window.saveWorkouts = async ()=>{
    clearMsg();
    const uid = effectiveUid();
    if(!uid) return showMsg("Login first.");
    try{
      await setDoc(doc(db,"users",uid,"workouts","plan"),{
        plan: window.__workPlan || emptyPlan(),
        updatedAt: serverTimestamp()
      },{merge:true});
      showMsg("Workouts saved ✅", true);
    }catch(e){
      showMsg(`Save workouts error: ${e.code||""} ${e.message||e}`);
    }
  };

  window.resetWorkouts = async ()=>{
    clearMsg();
    const uid = effectiveUid();
    if(!uid) return;
    window.__workPlan = emptyPlan();
    renderWorkoutUI(window.__workPlan);
    await setDoc(doc(db,"users",uid,"workouts","plan"),{ plan: window.__workPlan, updatedAt: serverTimestamp() },{merge:true});
    showMsg("Workouts reset ✅", true);
  };

  async function loadWorkouts(){
    const uid = effectiveUid();
    if(!uid) return;
    const snap = await getDoc(doc(db,"users",uid,"workouts","plan"));
    const plan = snap.exists() ? (snap.data().plan || emptyPlan()) : emptyPlan();
    window.__workPlan = plan;
    renderWorkoutUI(plan);
  }

  // ---------- BURN ----------
  function weekStartSunday(d=new Date()){
    const x = new Date(d);
    const day = x.getDay(); // 0 Sunday
    x.setHours(0,0,0,0);
    x.setDate(x.getDate() - day);
    return x;
  }
  function ymd(d){
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    const da=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }

  async function getWeeklyBurnTarget(uid){
    // weekly burn target = dailyDeficit * 7 (from calculator)
    const snap = await getDoc(doc(db,"users",uid,"calculator","current"));
    if(!snap.exists()) return 0;
    const d = snap.data();
    const daily = Math.max(0, Math.round(Number(d.dailyDeficit||0)));
    return daily * 7;
  }

  window.saveBurnToday = async ()=>{
    clearMsg();
    const uid = effectiveUid();
    if(!uid) return showMsg("Login first.");

    const v = Math.max(0, Math.round(Number(el("burnToday").value||0)));
    const key = ymd(new Date());
    try{
      await setDoc(doc(db,"users",uid,"burnLogs",key),{
        date:key, burned:v, updatedAt: serverTimestamp()
      },{merge:true});
      showMsg("Burn saved ✅", true);
      await loadBurnWeek();
    }catch(e){
      showMsg(`Burn save error: ${e.code||""} ${e.message||e}`);
    }
  };

  window.resetBurn = async ()=>{
    clearMsg();
    const uid = effectiveUid();
    if(!uid) return;
    const snaps = await getDocs(query(collection(db,"users",uid,"burnLogs"), limit(500)));
    const batch = writeBatch(db);
    snaps.forEach(s=> batch.delete(s.ref));
    await batch.commit();
    showMsg("Burn logs reset ✅", true);
    await loadBurnWeek();
  };

  async function loadBurnWeek(){
    const uid = effectiveUid();
    if(!uid) return;

    const weeklyTarget = await getWeeklyBurnTarget(uid);
    el("burnWeeklyTarget").value = weeklyTarget ? `${weeklyTarget} kcal` : "—";

    const start = weekStartSunday(new Date());
    const days = [];
    for(let i=0;i<7;i++){
      const d = new Date(start);
      d.setDate(start.getDate()+i);
      days.push(ymd(d));
    }

    const snaps = await getDocs(query(collection(db,"users",uid,"burnLogs"), orderBy("date","asc")));
    const map = new Map();
    snaps.forEach(s=>{ const x=s.data(); if(x?.date) map.set(x.date, x.burned||0); });

    let sum = 0;
    let listHtml = "";
    for(const k of days){
      const burned = map.get(k) || 0;
      sum += burned;
      listHtml += `<div class="msg ${burned>0 ? "ok" : ""}"><b>${k}</b><div class="muted">Burned: <b>${burned}</b> kcal</div></div>`;
    }
    el("burnList").innerHTML = listHtml;

    const remaining = Math.max(0, weeklyTarget - sum);
    const todayIndex = new Date().getDay(); // 0..6 Sunday..Saturday
    const remainingDays = Math.max(1, 7 - Math.max(0, todayIndex+1)); // days after today
    const tomorrowNeed = Math.round(remaining / remainingDays);

    el("burnSummary").innerHTML =
      `<b>Burned (logged):</b> ${sum} kcal<br>
       <b>Remaining to hit weekly target:</b> ${remaining} kcal<br>
       <b>Tomorrow burn target:</b> ${tomorrowNeed} kcal`;
  }

  // ---------- WEIGHT ----------
  window.saveWeight = async ()=>{
    clearMsg();
    const uid = effectiveUid();
    if(!uid) return showMsg("Login first.");
    const val = Number(el("wValue").value||0);
    const date = el("wDate").value || ymd(new Date());
    if(!val || val<=0) return showMsg("Enter weight value.");
    await setDoc(doc(db,"users",uid,"weightLogs",date),{
      date, weight: val, updatedAt: serverTimestamp()
    },{merge:true});
    showMsg("Weight saved ✅", true);
    await loadWeights();
  };

  window.resetWeight = async ()=>{
    clearMsg();
    const uid = effectiveUid();
    if(!uid) return;
    const snaps = await getDocs(query(collection(db,"users",uid,"weightLogs"), limit(800)));
    const batch = writeBatch(db);
    snaps.forEach(s=> batch.delete(s.ref));
    await batch.commit();
    showMsg("Weight logs reset ✅", true);
    await loadWeights();
  };

  async function loadWeights(){
    const uid = effectiveUid();
    if(!uid) return;
    const snaps = await getDocs(query(collection(db,"users",uid,"weightLogs"), orderBy("date","desc"), limit(200)));
    let html = "";
    snaps.forEach(s=>{
      const d = s.data();
      html += `<div class="msg ok"><b>${d.date}</b><div class="muted">Weight: <b>${d.weight}</b> kg</div></div>`;
    });
    el("weightList").innerHTML = html || `<div class="muted">No data yet.</div>`;
  }

  // ---------- ADMIN ----------
  window.adminLoadCoaches = async ()=>{
    clearMsg();
    if(currentProfile?.role !== "admin") return showMsg("Admin only.");
    const qy = query(collection(db,"users"), where("role","==","coach"), orderBy("createdAt","desc"), limit(200));
    const snaps = await getDocs(qy);
    let html = "";
    snaps.forEach(s=>{
      const d = s.data();
      html += `<div class="msg ok">
        <b>${escapeHtml(d.name||"Coach")}</b>
        <div class="muted mono">UID: ${s.id}</div>
      </div>`;
    });
    el("adminCoachList").innerHTML = html || `<div class="muted">No coaches.</div>`;
  };

  window.adminDisable = async ()=>{
    clearMsg();
    if(currentProfile?.role !== "admin") return showMsg("Admin only.");
    const uid = (el("adminDisableUid").value||"").trim();
    if(!uid) return showMsg("Paste UID.");
    await updateDoc(doc(db,"users",uid),{ disabled:true, updatedAt: serverTimestamp() });
    showMsg("Disabled ✅", true);
  };

  window.adminWipeAll = async ()=>{
    clearMsg();
    if(currentProfile?.role !== "admin") return showMsg("Admin only.");
    if(!confirm("ARE YOU SURE? This wipes Firestore users data.")) return;

    const snaps = await getDocs(query(collection(db,"users"), limit(500)));
    const batch = writeBatch(db);

    // only deletes users docs (subcollections remain; for full wipe use Firebase console)
    snaps.forEach(s=> batch.delete(s.ref));
    await batch.commit();

    showMsg("Wiped users collection ✅", true);
  };

  // ---------- SESSION / GATES ----------
  async function checkGate(profile){
    if(!profile) return true;
    if(profile.disabled){
      showMsg("Account disabled.", false);
      await signOut(auth);
      return false;
    }
    if(profile.role === "subscriber"){
      const exp = profile.subExpiresAt?.toMillis?.() || null;
      if(exp && Date.now() > exp){
        showMsg("Subscription expired.", false);
        await signOut(auth);
        return false;
      }
    }
    return true;
  }

  onAuthStateChanged(auth, async (user)=>{
    if(user){
      el("conn").textContent = "Firebase: CONNECTED";
      el("logoutBtn").disabled = false;

      // load profile
      const ref = doc(db,"users",user.uid);
      let snap = await getDoc(ref);
      if(!snap.exists()){
        // if someone exists in auth but no profile doc (rare)
        await setDoc(ref,{
          name:"User", nameKey:"user", role:"user", disabled:false,
          createdAt: serverTimestamp(), updatedAt: serverTimestamp()
        },{merge:true});
        snap = await getDoc(ref);
      }
      currentProfile = snap.data();

      // gate
      const ok = await checkGate(currentProfile);
      if(!ok) return;

      // status
      el("sessName").textContent = currentProfile?.name || "—";
      el("sessRole").textContent = "ROLE: " + (currentProfile?.role || "—");

      if(currentProfile?.role === "admin"){
        el("sessUid").classList.remove("hidden");
        el("sessUid").textContent = "UID: " + user.uid;
      }else{
        el("sessUid").classList.add("hidden");
      }

      // subscription badge
      if(currentProfile?.role==="subscriber" && currentProfile?.subExpiresAt){
        const expMs = currentProfile.subExpiresAt.toMillis();
        const startMs = currentProfile.subStartAt?.toMillis?.() || null;
        const daysLeft = Math.ceil((expMs - Date.now())/(24*60*60*1000));

        el("sessSub").classList.remove("hidden");
        el("sessSub").textContent = "SUB: exp " + formatDate(expMs);

        el("subBox").classList.remove("hidden");
        el("subInfo").innerHTML =
          `Start Date: <b>${startMs ? formatDate(startMs) : "—"}</b><br>
           Expiry Date: <b>${formatDate(expMs)}</b><br>
           Days Remaining: <b>${daysLeft}</b>`;
      } else {
        el("sessSub").classList.add("hidden");
        el("subBox").classList.add("hidden");
      }

      // fill profile fields
      el("pName").value = currentProfile?.name || "";
      el("pRole").value = currentProfile?.role || "";

      // show/hide tabs by role
      el("tAdmin").classList.toggle("hidden", currentProfile?.role!=="admin");
      el("tCoach").classList.toggle("hidden", !(currentProfile?.role==="coach" || currentProfile?.role==="admin"));

      // ranges
      fillSelectRange("cWeight", 0, 200);
      fillSelectRange("cHeight", 130, 210);
      fillSelectRange("cAge", 14, 80);
      applyDensityPreset();

      // show app
      el("authCard").classList.add("hidden");
      el("appCard").classList.remove("hidden");

      // default tab
      coachTargetUid = null;
      await setAppTab("profile");

      // preload coach subs if coach
      if(currentProfile?.role==="coach") await loadCoachSubscribers();
    }else{
      currentProfile = null;
      coachTargetUid = null;

      el("conn").textContent = "Firebase: —";
      el("logoutBtn").disabled = true;
      el("sessName").textContent = "—";
      el("sessRole").textContent = "ROLE: —";
      el("sessUid").classList.add("hidden");
      el("sessSub").classList.add("hidden");
      el("subBox").classList.add("hidden");

      el("authCard").classList.remove("hidden");
      el("appCard").classList.add("hidden");
    }
  });
</script>
</body>
</html>
