<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WS Fitness</title>

  <style>
    :root{
      --bg1:#0f172a; --bg2:#111827; --card:#1e293b; --ink:#e5e7eb;
      --muted:#94a3b8; --blue:#38bdf8; --blue2:#2563eb; --red:#fecaca; --green:#bbf7d0;
      --line:#334155; --soft:#0b1220;
    }
    *{box-sizing:border-box}
    body{
      margin:0; padding:18px; color:var(--ink);
      font-family: Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 10%, #0b3b6a22, transparent 60%),
                  radial-gradient(1200px 800px at 90% 30%, #2563eb22, transparent 55%),
                  linear-gradient(135deg,var(--bg1),var(--bg2));
    }
    .wrap{max-width:980px;margin:0 auto}
    h1{margin:0 0 14px; text-align:center; color:var(--blue); letter-spacing:.4px}
    .card{
      background: rgba(30,41,59,.86);
      border:1px solid rgba(51,65,85,.7);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 14px 40px rgba(0,0,0,.25);
      backdrop-filter: blur(8px);
      margin-bottom:12px;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .col{flex:1; min-width:220px}
    label{display:block; margin:10px 0 6px; font-weight:800}
    input,select,textarea{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(51,65,85,.95);
      background:var(--soft);
      color:var(--ink);
      outline:none;
      font-size:15px;
    }
    input::placeholder, textarea::placeholder{color:#64748b}
    textarea{min-height:90px; resize:vertical}
    button{
      width:100%;
      padding:13px 14px;
      border-radius:14px;
      border:0;
      background: linear-gradient(90deg,var(--blue),var(--blue2));
      color:white;
      font-weight:900;
      font-size:16px;
      cursor:pointer;
      margin-top:10px;
    }
    button.secondary{
      background:var(--soft);
      border:1px solid rgba(51,65,85,.95);
      color:var(--ink);
    }
    button.danger{ background:#ef4444; }
    .pill{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      background:var(--soft); border:1px solid rgba(51,65,85,.95);
      border-radius:14px; padding:10px 12px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px; border-radius:999px;
      background:var(--soft);
      border:1px solid rgba(51,65,85,.95);
      color:var(--muted);
      font-weight:900; font-size:12px
    }
    .msg{margin-top:10px; padding:10px 12px; border-radius:12px; border:1px solid rgba(51,65,85,.95); background:var(--soft)}
    .msg.ok{color:var(--green)}
    .msg.err{color:var(--red)}
    .hidden{display:none !important}
    .hr{height:1px;background:rgba(51,65,85,.95);margin:12px 0;border-radius:999px}
    .tabs{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .tab{
      flex:1; min-width:150px;
      border:1px solid rgba(51,65,85,.95);
      background:var(--soft);
      color:var(--ink);
      border-radius:12px;
      padding:12px;
      font-weight:900;
      cursor:pointer;
    }
    .tab.active{background:linear-gradient(90deg,var(--blue),var(--blue2)); border:0}
    .muted{color:var(--muted); font-size:13px; line-height:1.6}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace}
    .small{font-size:12px}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:760px){ .grid2{grid-template-columns:1fr} }

    /* Scroll احترافي */
    .scroll{
      max-height: 420px;
      overflow:auto;
      padding-right:6px;
      scrollbar-gutter: stable;
    }
    .scroll::-webkit-scrollbar{ width:10px; }
    .scroll::-webkit-scrollbar-track{ background: rgba(148,163,184,.12); border-radius:999px; }
    .scroll::-webkit-scrollbar-thumb{
      background: linear-gradient(180deg, rgba(56,189,248,.65), rgba(37,99,235,.65));
      border-radius:999px;
      border:2px solid rgba(15,23,42,.9);
    }
    .scroll::-webkit-scrollbar-thumb:hover{
      background: linear-gradient(180deg, rgba(56,189,248,.85), rgba(37,99,235,.85));
    }

    /* workouts compact rows */
    .work-row{
      display:grid;
      grid-template-columns: 1fr auto auto auto;
      gap:8px;
      align-items:center;
      background:var(--soft);
      border:1px solid rgba(51,65,85,.95);
      border-radius:12px;
      padding:10px;
      margin-top:8px;
    }
    .work-row input{margin:0}
    .btn-mini{
      width:auto;
      padding:10px 12px;
      border-radius:12px;
      margin:0;
      font-weight:900;
      font-size:13px;
      background:var(--soft);
      border:1px solid rgba(51,65,85,.95);
      color:var(--ink);
    }
    .btn-mini.primary{
      background:linear-gradient(90deg,var(--blue),var(--blue2));
      border:0;
      color:#fff;
    }
    details{
      background: rgba(11,18,32,.55);
      border:1px solid rgba(51,65,85,.8);
      border-radius:14px;
      padding:10px 12px;
      margin-top:10px;
    }
    summary{cursor:pointer; font-weight:900}
  </style>
</head>

<body>
<div class="wrap">
  <h1>WS Fitness</h1>

  <!-- STATUS BAR -->
  <div class="card">
    <div class="pill">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <span class="badge">Session: <b id="sessEmail">—</b></span>
        <span class="badge" id="sessRole">ROLE: —</span>

        <!-- UID يظهر للأدمن فقط -->
        <span class="badge hidden" id="sessUid">UID: —</span>

        <!-- للمشترك فقط -->
        <span class="badge hidden" id="sessSub">SUB: —</span>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <span class="badge" id="conn">Firebase: —</span>
        <button class="secondary" style="width:auto;margin:0;padding:10px 12px" id="logoutBtn" onclick="logout()" disabled>Logout</button>
      </div>
    </div>
    <div class="muted" style="margin-top:10px">
      عربي/English • Admin / Coach / Subscriber / User • بيانات سحابية على أكثر من جهاز
    </div>
  </div>

  <!-- AUTH -->
  <div class="card" id="authCard">
    <div class="tabs">
      <button class="tab active" id="tabLogin" onclick="setAuthMode('login')">تسجيل دخول | Login</button>
      <button class="tab" id="tabUser" onclick="setAuthMode('user')">Create User</button>
      <button class="tab" id="tabCoach" onclick="setAuthMode('coach')">Create Coach</button>
      <button class="tab" id="tabSub" onclick="setAuthMode('subscriber')">Create Subscriber</button>
    </div>

    <div id="panelLogin">
      <div class="row">
        <div class="col">
          <label>Email</label>
          <input id="loginEmail" placeholder="email@example.com" inputmode="email" autocomplete="email">
        </div>
        <div class="col">
          <label>Password</label>
          <input id="loginPass" type="password" placeholder="••••••••" autocomplete="current-password">
        </div>
      </div>
      <button onclick="login()">Login</button>
    </div>

    <div id="panelUser" class="hidden">
      <div class="row">
        <div class="col">
          <label>Name | الاسم</label>
          <input id="userName" placeholder="Name">
        </div>
        <div class="col">
          <label>Email</label>
          <input id="userEmail" placeholder="email@example.com" inputmode="email" autocomplete="email">
        </div>
        <div class="col">
          <label>Password</label>
          <input id="userPass" type="password" placeholder="min 6 characters" autocomplete="new-password">
        </div>
      </div>
      <button onclick="createAccount('user')">Create User</button>
    </div>

    <div id="panelCoach" class="hidden">
      <div class="row">
        <div class="col">
          <label>Name | الاسم</label>
          <input id="coachName" placeholder="Coach name">
        </div>
        <div class="col">
          <label>Email</label>
          <input id="coachEmail" placeholder="email@example.com" inputmode="email" autocomplete="email">
        </div>
        <div class="col">
          <label>Password</label>
          <input id="coachPass" type="password" placeholder="min 6 characters" autocomplete="new-password">
        </div>
      </div>
      <button onclick="createAccount('coach')">Create Coach</button>
    </div>

    <div id="panelSubscriber" class="hidden">
      <div class="row">
        <div class="col">
          <label>Name | الاسم</label>
          <input id="subName" placeholder="Subscriber name">
        </div>
        <div class="col">
          <label>Email</label>
          <input id="subEmail" placeholder="email@example.com" inputmode="email" autocomplete="email">
        </div>
        <div class="col">
          <label>Password</label>
          <input id="subPass" type="password" placeholder="min 6 characters" autocomplete="new-password">
        </div>
        <div class="col">
          <label>Invite Code</label>
          <input id="subInvite" class="mono" placeholder="e.g. 9K4Q8Z2M" autocomplete="off" autocapitalize="characters">
        </div>
      </div>
      <button onclick="createSubscriberWithInvite()">Create Subscriber</button>
      <div class="muted">المشترك لازم يدخل Invite Code من المدرب.</div>
    </div>

    <div id="msg" class="msg hidden"></div>
  </div>

  <!-- APP -->
  <div class="card hidden" id="appCard">
    <!-- TOP NAV -->
    <div class="tabs" id="appTabs">
      <!-- ✅ FIX: IDs must match JS: tProfile tCalculator tWorkouts ... -->
      <button class="tab active" id="tProfile" onclick="setAppTab('profile')">Profile</button>
      <button class="tab" id="tCalculator" onclick="setAppTab('calculator')">Calculator</button>
      <button class="tab" id="tWorkouts" onclick="setAppTab('workouts')">Workouts</button>
      <button class="tab" id="tBurn" onclick="setAppTab('burn')">Daily Burn</button>
      <button class="tab" id="tWeight" onclick="setAppTab('weight')">Weight</button>
      <button class="tab hidden" id="tCoach" onclick="setAppTab('coach')">Coach</button>
      <button class="tab hidden" id="tAdmin" onclick="setAppTab('admin')">Admin</button>
    </div>

    <!-- CONTENT -->
    <div class="hr"></div>

    <!-- PROFILE -->
    <div id="pageProfile">
      <div class="row">
        <div class="col">
          <label>Name | الاسم</label>
          <input id="pName" placeholder="Name">
        </div>
        <div class="col">
          <label>Role</label>
          <input id="pRole" disabled>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Change Password | تغيير كلمة المرور</label>
          <input id="newPass" type="password" placeholder="New password (min 6)">
          <button class="secondary" onclick="changePassword()">Update Password</button>
        </div>
      </div>

      <!-- Subscription box for subscribers only -->
      <div id="subBox" class="msg hidden">
        <div style="font-weight:900;margin-bottom:6px">Subscription | الاشتراك</div>
        <div id="subInfo" class="muted">—</div>
      </div>

      <button onclick="saveProfile()">Save Profile</button>
    </div>

    <!-- CALCULATOR -->
    <div id="pageCalculator" class="hidden">
      <div class="grid2">
        <div>
          <label>Weight (kg) | الوزن</label>
          <select id="cWeight"></select>
        </div>
        <div>
          <label>Height (cm) | الطول</label>
          <select id="cHeight"></select>
        </div>
        <div>
          <label>Age | العمر</label>
          <select id="cAge"></select>
        </div>
        <div>
          <label>Gender | الجنس</label>
          <select id="cGender">
            <option value="male">Male | ذكر</option>
            <option value="female">Female | أنثى</option>
          </select>
        </div>
        <div>
          <label>Training Days (1–6) | أيام النشاط</label>
          <select id="cDays">
            <option>1</option><option>2</option><option>3</option>
            <option>4</option><option>5</option><option>6</option>
          </select>
        </div>
        <div>
          <label>Protein x Bodyweight | ضرب البروتين</label>
          <select id="cProtMult">
            <option value="1.5">1.5</option><option value="1.6">1.6</option><option value="1.7">1.7</option>
            <option value="1.8">1.8</option><option value="1.9">1.9</option>
            <option value="2.0" selected>2.0</option>
            <option value="2.1">2.1</option><option value="2.2">2.2</option><option value="2.3">2.3</option>
            <option value="2.4">2.4</option><option value="2.5">2.5</option><option value="2.6">2.6</option>
            <option value="2.7">2.7</option><option value="2.8">2.8</option><option value="2.9">2.9</option>
            <option value="3.0">3.0</option>
          </select>
        </div>
        <div>
          <label>Meals | عدد الوجبات (1–6)</label>
          <select id="cMeals">
            <option>1</option><option>2</option><option>3</option>
            <option selected>4</option><option>5</option><option>6</option>
          </select>
        </div>
        <div>
          <label>Weekly Goal (kg) | هدف أسبوعي</label>
          <select id="cWeekly">
            <option value="0.5">0.5</option>
            <option value="0.75">0.75</option>
            <option value="1.0" selected>1.0</option>
            <option value="1.25">1.25</option>
            <option value="1.5">1.5</option>
            <option value="1.75">1.75</option>
            <option value="2.0">2.0</option>
          </select>
        </div>
        <div>
          <label>Density | كثافة</label>
          <select id="cDensity">
            <option value="low">Low | خفيف</option>
            <option value="normal" selected>Normal | عادي</option>
            <option value="high">High | عالي</option>
          </select>
        </div>
      </div>

      <button onclick="calcNow()">احسب | Calculate</button>

      <div class="hr"></div>

      <div class="scroll">
        <div class="msg ok hidden" id="calcOut"></div>
        <div class="msg hidden" id="mealOut"></div>
      </div>

      <button class="secondary" onclick="saveCalc()">Save Results</button>
      <div class="muted">Per Meal = grams “on the scale” بدون أسماء أطعمة.</div>
    </div>

    <!-- WORKOUTS -->
    <div id="pageWorkouts" class="hidden">
      <div class="row" id="coachTargetRow" class="hidden">
        <div class="col">
          <label>Coach: Select Subscriber | اختر مشترك</label>
          <select id="coachTarget"></select>
        </div>
      </div>

      <div class="muted">الأيام مرتبة: Sunday → Saturday</div>
      <div class="scroll" id="workScroll"></div>
      <button class="secondary" onclick="saveWorkouts()">Save Workouts</button>
    </div>

    <!-- DAILY BURN -->
    <div id="pageBurn" class="hidden">
      <div class="row" id="burnCoachTargetRow" class="hidden">
        <div class="col">
          <label>Coach: Select Subscriber | اختر مشترك</label>
          <select id="burnCoachTarget"></select>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Burned Today (kcal) | المحروق اليوم</label>
          <input id="burnToday" type="number" min="0" placeholder="e.g. 500">
          <button onclick="saveBurnToday()">Save Today</button>
        </div>
        <div class="col">
          <label>Daily Target Burn (kcal) | الهدف اليومي</label>
          <input id="burnTarget" disabled>
        </div>
      </div>

      <div class="msg" id="burnSummary">—</div>
      <div class="hr"></div>

      <div class="scroll">
        <div class="muted">هذا الأسبوع (يبدأ Sunday)</div>
        <div id="burnList"></div>
      </div>
    </div>

    <!-- WEIGHT -->
    <div id="pageWeight" class="hidden">
      <div class="row" id="weightCoachTargetRow" class="hidden">
        <div class="col">
          <label>Coach: Select Subscriber | اختر مشترك</label>
          <select id="weightCoachTarget"></select>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Weight (kg) | الوزن</label>
          <input id="wValue" type="number" min="0" max="300" step="0.1" placeholder="e.g. 95.2">
        </div>
        <div class="col">
          <label>Week Date | تاريخ الأسبوع</label>
          <input id="wDate" type="date">
        </div>
      </div>

      <button onclick="saveWeight()">Save Weekly Weight</button>
      <div class="hr"></div>
      <div class="scroll" id="weightList"></div>
    </div>

    <!-- COACH -->
    <div id="pageCoach" class="hidden">
      <div style="font-weight:900;color:var(--blue);font-size:16px">Coach Panel: Invite Codes</div>
      <div class="muted">Generate an invite code and send it to your subscriber.</div>

      <div class="row">
        <div class="col">
          <label>Subscription Months (1–6)</label>
          <select id="invMonths">
            <option value="1">1 month</option><option value="2">2 months</option><option value="3">3 months</option>
            <option value="4">4 months</option><option value="5">5 months</option><option value="6">6 months</option>
          </select>
        </div>
        <div class="col">
          <label>Invite Code Length</label>
          <select id="invLen">
            <option value="6">6</option><option value="8" selected>8</option><option value="10">10</option>
          </select>
        </div>
      </div>

      <button onclick="coachCreateInvite()">Generate Invite Code</button>

      <div class="msg ok hidden" id="inviteOut"></div>
      <button class="secondary" onclick="copyInvite()" id="copyBtn" disabled>Copy Invite Code</button>

      <div class="hr"></div>

      <div style="font-weight:900;color:var(--blue);font-size:16px">My Subscribers</div>
      <div class="muted">اختر مشترك للتعديل من Workouts/Daily Burn/Weight عبر القوائم.</div>
      <div class="scroll" id="subsList"></div>
    </div>

    <!-- ADMIN -->
    <div id="pageAdmin" class="hidden">
      <div style="font-weight:900;color:var(--blue);font-size:16px">Admin Panel</div>

      <div class="row">
        <div class="col">
          <label>Target UID</label>
          <input id="adminTargetUid" class="mono" placeholder="paste UID">
        </div>
        <div class="col">
          <label>Set Role</label>
          <select id="adminRole">
            <option value="user">user</option>
            <option value="coach">coach</option>
            <option value="subscriber">subscriber</option>
            <option value="admin">admin</option>
          </select>
        </div>
      </div>
      <button onclick="adminSetRole()">Update Role</button>

      <div class="hr"></div>

      <div class="row">
        <div class="col">
          <label>Reset Firestore data for UID (keeps Auth account)</label>
          <input id="resetUid" class="mono" placeholder="UID">
          <button class="danger" onclick="adminResetUserData()">Reset User Data</button>
        </div>
      </div>

      <div class="muted small">Reset يمسح البيانات من Firestore فقط.</div>
    </div>

  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
    signOut, onAuthStateChanged, updatePassword
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp,
    Timestamp, runTransaction, collection, query, where, getDocs, orderBy,
    writeBatch, deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAK06AL_e24OQuoWvNmp9I6Xkc2Yx9ZoBc",
    authDomain: "ws-fitness.firebaseapp.com",
    projectId: "ws-fitness",
    storageBucket: "ws-fitness.firebasestorage.app",
    messagingSenderId: "639434705944",
    appId: "1:639434705944:web:4f0eef88b76e4d856c076d",
    measurementId: "G-BZG7GS5ZDW"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const el = (id)=>document.getElementById(id);
  const msgBox = el("msg");

  let currentProfile = null;
  let lastInviteCode = "";
  let activeTab = "profile";

  let coachTargetUid = null;
  function effectiveUid(){
    const role = currentProfile?.role;
    if(role === "coach" && coachTargetUid) return coachTargetUid;
    return auth.currentUser?.uid || null;
  }

  function showMsg(text, ok=false){
    msgBox.classList.remove("hidden","ok","err");
    msgBox.classList.add(ok ? "ok" : "err");
    msgBox.textContent = text;
  }
  function clearMsg(){ msgBox.classList.add("hidden"); msgBox.textContent=""; }

  window.setAuthMode = (mode)=>{
    clearMsg();
    el("tabLogin").classList.toggle("active", mode==="login");
    el("tabUser").classList.toggle("active", mode==="user");
    el("tabCoach").classList.toggle("active", mode==="coach");
    el("tabSub").classList.toggle("active", mode==="subscriber");

    el("panelLogin").classList.toggle("hidden", mode!=="login");
    el("panelUser").classList.toggle("hidden", mode!=="user");
    el("panelCoach").classList.toggle("hidden", mode!=="coach");
    el("panelSubscriber").classList.toggle("hidden", mode!=="subscriber");
  };

  function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1); }

  window.setAppTab = async (tab)=>{
    activeTab = tab;
    const tabs = ["profile","calculator","workouts","burn","weight","coach","admin"];
    for(const t of tabs){
      const tabBtn = el("t"+cap(t));
      const page = el("page"+cap(t));
      if(tabBtn) tabBtn.classList.toggle("active", t===tab);
      if(page) page.classList.toggle("hidden", t!==tab);
    }
    if(tab==="calculator") await loadCalc();
    if(tab==="workouts") await loadWorkouts();
    if(tab==="burn") await loadBurnWeek();
    if(tab==="weight") await loadWeights();
    if(tab==="coach") await loadCoachSubscribers();
  };

  window.login = async ()=>{
    clearMsg();
    const email = (el("loginEmail").value||"").trim();
    const pass  = (el("loginPass").value||"").trim();
    if(!email || !pass) return showMsg("Enter email + password.");
    try{
      await signInWithEmailAndPassword(auth, email, pass);
      showMsg("Logged in ✅", true);
    }catch(e){
      showMsg(`Login error: ${e.code || ""} ${e.message || e}`);
    }
  };

  window.createAccount = async (role)=>{
    clearMsg();
    const nameEl = role==="coach" ? el("coachName") : el("userName");
    const emailEl= role==="coach" ? el("coachEmail") : el("userEmail");
    const passEl = role==="coach" ? el("coachPass") : el("userPass");
    const name = (nameEl.value||"").trim();
    const email= (emailEl.value||"").trim();
    const pass = (passEl.value||"").trim();

    if(!name || !email || !pass) return showMsg("Enter name + email + password.");
    if(pass.length < 6) return showMsg("Password must be at least 6 characters.");

    try{
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      const uid = cred.user.uid;

      await setDoc(doc(db, "users", uid), {
        name,
        role, // user | coach
        active: true,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      }, { merge:true });

      showMsg(`Account created as ${role.toUpperCase()} ✅`, true);
    }catch(e){
      showMsg(`Create error: ${e.code || ""} ${e.message || e}`);
    }
  };

  window.createSubscriberWithInvite = async ()=>{
    clearMsg();
    const name = (el("subName").value||"").trim();
    const email= (el("subEmail").value||"").trim();
    const pass = (el("subPass").value||"").trim();
    const invite = (el("subInvite").value||"").trim().toUpperCase();

    if(!name || !email || !pass || !invite) return showMsg("Enter name + email + password + invite code.");
    if(pass.length < 6) return showMsg("Password must be at least 6 characters.");

    try{
      const cred = await createUserWithEmailAndPassword(auth, email, pass);
      const uid = cred.user.uid;

      await runTransaction(db, async (tx)=>{
        const invRef = doc(db, "invites", invite);
        const invSnap = await tx.get(invRef);
        if(!invSnap.exists()) throw new Error("Invalid invite code.");

        const inv = invSnap.data();
        if(inv.usedBy) throw new Error("Invite already used.");
        if(inv.expiresAt && inv.expiresAt.toMillis() <= Date.now()) throw new Error("Invite expired.");

        const coachId = inv.coachId;
        const months = clamp(Number(inv.months || 1), 1, 6);
        const startMs = Date.now();
        const expMs = addMonthsMillis(startMs, months);

        tx.set(doc(db, "users", uid), {
          name,
          role: "subscriber",
          coachId,
          inviteCode: invite,
          active: true,
          subStartAt: Timestamp.fromMillis(startMs),
          subExpiresAt: Timestamp.fromMillis(expMs),
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge:true });

        tx.update(invRef, { usedBy: uid, usedAt: serverTimestamp() });
      });

      showMsg("Subscriber created ✅", true);
    }catch(e){
      showMsg(`Subscriber error: ${e.code || ""} ${e.message || e}`);
    }
  };

  window.logout = async ()=>{ clearMsg(); await signOut(auth); };

  window.saveProfile = async ()=>{
    clearMsg();
    const uid = auth.currentUser?.uid;
    if(!uid) return showMsg("Please login.");
    try{
      await updateDoc(doc(db,"users",uid), {
        name: (el("pName").value||"").trim(),
        updatedAt: serverTimestamp()
      });
      showMsg("Saved ✅", true);
    }catch(e){
      showMsg(`Save error: ${e.code||""} ${e.message||e}`);
    }
  };

  window.changePassword = async ()=>{
    clearMsg();
    const p = (el("newPass").value||"").trim();
    if(p.length < 6) return showMsg("Password must be at least 6 characters.");
    try{
      await updatePassword(auth.currentUser, p);
      el("newPass").value = "";
      showMsg("Password updated ✅", true);
    }catch(e){
      showMsg(`Password error: ${e.code||""} ${e.message||e}`);
    }
  };

  function fillSelectRange(selId, start, end){
    const s = el(selId);
    s.innerHTML = "";
    for(let i=start; i<=end; i++){
      const opt = document.createElement("option");
      opt.value = String(i);
      opt.textContent = String(i);
      s.appendChild(opt);
    }
  }
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  function calcBMR(w,h,a,gender){
    if(gender==="male") return (10*w) + (6.25*h) - (5*a) + 5;
    return (10*w) + (6.25*h) - (5*a) - 161;
  }
  function activityFactor(days){
    const map = {1:1.35,2:1.42,3:1.50,4:1.58,5:1.65,6:1.72};
    return map[days] || 1.5;
  }
  function densityAdj(d){
    if(d==="low") return 0.95;
    if(d==="high") return 1.05;
    return 1.0;
  }

  window.calcNow = ()=>{
    clearMsg();

    const w = Number(el("cWeight").value);
    const h = Number(el("cHeight").value);
    const a = Number(el("cAge").value);
    const gender = el("cGender").value;
    const days = Number(el("cDays").value);
    const pm = Number(el("cProtMult").value);
    const meals = Number(el("cMeals").value);
    const weekly = Number(el("cWeekly").value);
    const density = el("cDensity").value;

    const bmr = calcBMR(w,h,a,gender);
    const tdee = bmr * activityFactor(days) * densityAdj(density);

    const dailyDeficit = (weekly * 7700) / 7;
    const targetCalories = Math.max(1200, Math.round(tdee - dailyDeficit));

    const proteinG = Math.round(w * pm);
    const fatG = Math.round(w * 0.8);
    const proteinK = proteinG * 4;
    const fatK = fatG * 9;

    const remainingK = Math.max(0, targetCalories - proteinK - fatK);
    const carbsG = Math.round(remainingK / 4);

    const pMeal = Math.round((proteinG / meals) * 10) / 10;
    const cMeal = Math.round((carbsG / meals) * 10) / 10;
    const fMeal = Math.round((fatG / meals) * 10) / 10;

    el("calcOut").classList.remove("hidden");
    el("calcOut").innerHTML =
      `<div style="font-weight:900;margin-bottom:6px">Results | النتائج</div>
       <div class="muted">
        BMR: <b>${Math.round(bmr)}</b> kcal<br>
        TDEE: <b>${Math.round(tdee)}</b> kcal<br>
        Target Calories: <b>${targetCalories}</b> kcal/day<br>
        Daily Burn Target: <b>${Math.round(dailyDeficit)}</b> kcal/day
       </div>
       <div class="hr"></div>
       <div class="muted">
        Protein: <b>${proteinG}</b> g/day<br>
        Carbs: <b>${carbsG}</b> g/day<br>
        Fat: <b>${fatG}</b> g/day
       </div>`;

    el("mealOut").classList.remove("hidden");
    el("mealOut").innerHTML =
      `<div style="font-weight:900;margin-bottom:6px">Per Meal (Scale g) | لكل وجبة (بالميزان)</div>
       <div class="muted">
         Meals: <b>${meals}</b><br>
         Protein/meal: <b>${pMeal}</b> g<br>
         Carbs/meal: <b>${cMeal}</b> g<br>
         Fat/meal: <b>${fMeal}</b> g
       </div>`;

    window.__calcCache = {w,h,a,gender,days,pm,meals,weekly,density,bmr,tdee,targetCalories,dailyDeficit,proteinG,carbsG,fatG,pMeal,cMeal,fMeal};
  };

  window.saveCalc = async ()=>{
    clearMsg();
    const uid = effectiveUid();
    if(!uid) return showMsg("Please login.");
    if(!window.__calcCache) return showMsg("Calculate first.");
    try{
      await setDoc(doc(db, "users", uid, "calculator", "current"), {
        ...window.__calcCache,
        updatedAt: serverTimestamp()
      }, {merge:true});
      showMsg("Calculator saved ✅", true);
    }catch(e){
      showMsg(`Save error: ${e.code||""} ${e.message||e}`);
    }
  };

  function safeSet(id, val){
    const s = el(id);
    if(!s) return;
    if(val===undefined || val===null) return;
    const v = String(val);
    for(const opt of s.options){
      if(opt.value === v){ s.value = v; return; }
    }
  }

  async function loadCalc(){
    const uid = effectiveUid();
    if(!uid) return;
    try{
      const snap = await getDoc(doc(db,"users",uid,"calculator","current"));
      if(snap.exists()){
        const d = snap.data();
        safeSet("cWeight", d.w);
        safeSet("cHeight", d.h);
        safeSet("cAge", d.a);
        safeSet("cGender", d.gender);
        safeSet("cDays", d.days);
        safeSet("cProtMult", d.pm);
        safeSet("cMeals", d.meals);
        safeSet("cWeekly", d.weekly);
        safeSet("cDensity", d.density);
        window.__calcCache = d;

        el("calcOut").classList.remove("hidden");
        el("mealOut").classList.remove("hidden");
        el("calcOut").innerHTML =
          `<div style="font-weight:900;margin-bottom:6px">Saved Results | النتائج المحفوظة</div>
           <div class="muted">
            Target Calories: <b>${d.targetCalories}</b> kcal/day<br>
            Daily Burn Target: <b>${Math.round(d.dailyDeficit||0)}</b> kcal/day
           </div>
           <div class="hr"></div>
           <div class="muted">
            Protein: <b>${d.proteinG}</b> g/day<br>
            Carbs: <b>${d.carbsG}</b> g/day<br>
            Fat: <b>${d.fatG}</b> g/day
           </div>`;
        el("mealOut").innerHTML =
          `<div style="font-weight:900;margin-bottom:6px">Per Meal (Scale g) | لكل وجبة (بالميزان)</div>
           <div class="muted">
             Meals: <b>${d.meals}</b><br>
             Protein/meal: <b>${d.pMeal}</b> g<br>
             Carbs/meal: <b>${d.cMeal}</b> g<br>
             Fat/meal: <b>${d.fMeal}</b> g
           </div>`;
      } else {
        el("calcOut").classList.add("hidden");
        el("mealOut").classList.add("hidden");
      }
    }catch(e){
      showMsg(`Load error: ${e.code||""} ${e.message||e}`);
    }
  }

  const weekDays = [
    {key:"sunday", label:"Sunday"},
    {key:"monday", label:"Monday"},
    {key:"tuesday", label:"Tuesday"},
    {key:"wednesday", label:"Wednesday"},
    {key:"thursday", label:"Thursday"},
    {key:"friday", label:"Friday"},
    {key:"saturday", label:"Saturday"},
  ];
  function emptyPlan(){ const o={}; for(const d of weekDays) o[d.key]=[]; return o; }

  function renderWorkRow(day, idx, item){
    const row = document.createElement("div");
    row.className = "work-row";

    const name = document.createElement("input");
    name.placeholder = "Exercise | اسم التمرين";
    name.value = item?.name || "";
    name.oninput = ()=>{ item.name = name.value; };

    const setsBtn = document.createElement("button");
    setsBtn.className = "btn-mini primary";
    setsBtn.textContent = `Sets: ${item?.sets ?? 3}`;
    setsBtn.onclick = ()=>{
      item.sets = clamp((item.sets||3)+1, 1, 20);
      setsBtn.textContent = `Sets: ${item.sets}`;
    };

    const maxBtn = document.createElement("button");
    maxBtn.className = "btn-mini";
    maxBtn.textContent = `Max: ${item?.maxKg ?? 0} kg`;
    maxBtn.onclick = ()=>{
      const v = prompt("Max weight (kg):", String(item.maxKg ?? 0));
      if(v===null) return;
      const n = clamp(Number(v)||0, 0, 500);
      item.maxKg = n;
      maxBtn.textContent = `Max: ${item.maxKg} kg`;
    };

    const del = document.createElement("button");
    del.className = "btn-mini";
    del.textContent = "✕";
    del.onclick = ()=>{
      const items = window.__workPlan[day];
      items.splice(idx,1);
      renderWorkoutUI(window.__workPlan);
    };

    row.appendChild(name);
    row.appendChild(setsBtn);
    row.appendChild(maxBtn);
    row.appendChild(del);
    return row;
  }

  function renderWorkoutUI(plan){
    const wrap = el("workScroll");
    wrap.innerHTML = "";
    for(const d of weekDays){
      const det = document.createElement("details");
      det.open = false;

      const sum = document.createElement("summary");
      sum.textContent = d.label;
      det.appendChild(sum);

      const list = document.createElement("div");
      const items = plan?.[d.key] || [];
      for(let i=0;i<items.length;i++){
        list.appendChild(renderWorkRow(d.key, i, items[i]));
      }

      const addBtn = document.createElement("button");
      addBtn.className = "secondary";
      addBtn.textContent = "Add Exercise | إضافة تمرين";
      addBtn.onclick = ()=>{
        plan[d.key].push({name:"", sets:3, maxKg:0});
        renderWorkoutUI(plan);
      };

      det.appendChild(list);
      det.appendChild(addBtn);
      wrap.appendChild(det);
    }
  }

  window.saveWorkouts = async ()=>{
    clearMsg();
    const uid = effectiveUid();
    if(!uid) return showMsg("Please login.");
    if(!window.__workPlan) return showMsg("No plan loaded.");
    try{
      await setDoc(doc(db,"users",uid,"workouts","plan"), {
        plan: window.__workPlan,
        updatedAt: serverTimestamp()
      }, {merge:true});
      showMsg("Workouts saved ✅", true);
    }catch(e){
      showMsg(`Save error: ${e.code||""} ${e.message||e}`);
    }
  };

  async function loadWorkouts(){
    const uid = effectiveUid();
    if(!uid) return;
    try{
      const snap = await getDoc(doc(db,"users",uid,"workouts","plan"));
      const plan = snap.exists() ? (snap.data().plan || emptyPlan()) : emptyPlan();
      window.__workPlan = plan;
      renderWorkoutUI(plan);
    }catch(e){
      showMsg(`Load error: ${e.code||""} ${e.message||e}`);
    }
  }

  function weekStartSunday(d=new Date()){
    const x = new Date(d);
    const day = x.getDay();
    x.setHours(0,0,0,0);
    x.setDate(x.getDate() - day);
    return x;
  }
  function ymd(d){
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    const da=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }

  async function getDailyTargetBurn(uid){
    const snap = await getDoc(doc(db,"users",uid,"calculator","current"));
    if(!snap.exists()) return 0;
    const d = snap.data();
    return Math.max(0, Math.round(Number(d.dailyDeficit || 0)));
  }

  window.saveBurnToday = async ()=>{
    clearMsg();
    const uid = effectiveUid();
    if(!uid) return showMsg("Please login.");

    const v = Math.max(0, Math.round(Number(el("burnToday").value||0)));
    const key = ymd(new Date());

    try{
      await setDoc(doc(db,"users",uid,"burnLogs",key), {
        date: key,
        burned: v,
        updatedAt: serverTimestamp()
      }, {merge:true});
      showMsg("Saved burn ✅", true);
      await loadBurnWeek();
    }catch(e){
      showMsg(`Save error: ${e.code||""} ${e.message||e}`);
    }
  };

  async function loadBurnWeek(){
    const uid = effectiveUid();
    if(!uid) return;

    try{
      const target = await getDailyTargetBurn(uid);
      el("burnTarget").value = target ? String(target) : "—";

      const start = weekStartSunday(new Date());
      const days = [];
      for(let i=0;i<7;i++){
        const d = new Date(start);
        d.setDate(start.getDate()+i);
        days.push(ymd(d));
      }

      const snaps = await getDocs(query(collection(db,"users",uid,"burnLogs"), orderBy("date","asc")));
      const map = new Map();
      snaps.forEach(s=>{ const x=s.data(); if(x?.date) map.set(x.date, x.burned||0); });

      let sum = 0;
      let filled = 0;
      let listHtml = "";
      const todayKey = ymd(new Date());

      for(const k of days){
        const burned = map.has(k) ? map.get(k) : 0;
        if(map.has(k)) filled++;
        sum += burned;
        const mark = (k===todayKey) ? " (Today)" : "";
        listHtml += `<div class="msg ${map.has(k) ? "ok" : ""}"><b>${k}${mark}</b><div class="muted">Burned: <b>${burned}</b> kcal</div></div>`;
      }
      el("burnList").innerHTML = listHtml;

      const weeklyTarget = target * 7;
      const remaining = Math.max(0, weeklyTarget - sum);
      const remainingDays = Math.max(1, 7 - Math.min(7, filled));
      const needPerDay = Math.round(remaining / remainingDays);

      el("burnSummary").innerHTML =
        `<div style="font-weight:900;margin-bottom:6px">This Week Summary | ملخص الأسبوع</div>
         <div class="muted">
           Daily target burn: <b>${target}</b> kcal<br>
           Weekly target burn: <b>${weeklyTarget}</b> kcal<br>
           Burned so far: <b>${sum}</b> kcal<br>
           Remaining: <b>${remaining}</b> kcal<br>
           Suggested next-day burn: <b>${needPerDay}</b> kcal
         </div>`;
    }catch(e){
      showMsg(`Load error: ${e.code||""} ${e.message||e}`);
    }
  }

  window.saveWeight = async ()=>{
    clearMsg();
    const uid = effectiveUid();
    if(!uid) return showMsg("Please login.");

    const val = Number(el("wValue").value||0);
    const date = el("wDate").value || ymd(new Date());
    if(!val || val<=0) return showMsg("Enter weight value.");

    try{
      await setDoc(doc(db,"users",uid,"weightLogs",date), {
        date,
        weight: val,
        updatedAt: serverTimestamp()
      }, {merge:true});
      showMsg("Saved weight ✅", true);
      await loadWeights();
    }catch(e){
      showMsg(`Save error: ${e.code||""} ${e.message||e}`);
    }
  };

  async function loadWeights(){
    const uid = effectiveUid();
    if(!uid) return;

    try{
      const snaps = await getDocs(query(collection(db,"users",uid,"weightLogs"), orderBy("date","desc")));
      let html = "";
      snaps.forEach(s=>{
        const d = s.data();
        html += `<div class="msg ok"><b>${d.date}</b><div class="muted">Weight: <b>${d.weight}</b> kg</div></div>`;
      });
      el("weightList").innerHTML = html || `<div class="muted">No data yet.</div>`;
    }catch(e){
      showMsg(`Load error: ${e.code||""} ${e.message||e}`);
    }
  }

  function makeCode(len=8){
    const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let s="";
    for(let i=0;i<len;i++) s += chars[Math.floor(Math.random()*chars.length)];
    return s;
  }
  function addMonthsMillis(startMs, months){
    const d = new Date(startMs);
    const day = d.getDate();
    d.setMonth(d.getMonth()+months);
    if(d.getDate() < day) d.setDate(0);
    return d.getTime();
  }

  window.coachCreateInvite = async ()=>{
    clearMsg();
    const user = auth.currentUser;
    if(!user) return showMsg("Please login.");

    try{
      const role = currentProfile?.role || "";
      if(role !== "coach" && role !== "admin") return showMsg("Only coach/admin can create invites.");

      const months = clamp(Number(el("invMonths").value||"1"),1,6);
      const len = clamp(Number(el("invLen").value||"8"),6,10);

      let code = "";
      for(let i=0;i<6;i++){
        const c = makeCode(len);
        const test = await getDoc(doc(db,"invites",c));
        if(!test.exists()){ code=c; break; }
      }
      if(!code) throw new Error("Try again.");

      const now = Date.now();
      const expiresAt = Timestamp.fromMillis(now + (14*24*60*60*1000));

      await setDoc(doc(db,"invites",code),{
        coachId: user.uid,
        months,
        createdAt: serverTimestamp(),
        expiresAt,
        usedBy: null,
        usedAt: null
      });

      lastInviteCode = code;
      el("inviteOut").classList.remove("hidden");
      el("inviteOut").innerHTML = `<b>Invite Code:</b> <span class="mono">${code}</span><br><span class="muted">Subscription: ${months} month(s)</span>`;
      el("copyBtn").disabled = false;

      showMsg("Invite created ✅", true);
    }catch(e){
      showMsg(`Invite error: ${e.code||""} ${e.message||e}`);
    }
  };

  window.copyInvite = async ()=>{
    if(!lastInviteCode) return;
    try{
      await navigator.clipboard.writeText(lastInviteCode);
      showMsg("Copied ✅", true);
    }catch{
      showMsg("Copy failed. Copy manually from the invite box.");
    }
  };

  function escapeHtml(s){
    return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function formatDate(ms){
    const d=new Date(ms);
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,"0");
    const da=String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }

  // ✅ FIX: avoid composite index by querying coachId only, then filtering in JS
  async function loadCoachSubscribers(){
    if(!currentProfile) return;
    const role = currentProfile.role;
    if(role !== "coach" && role !== "admin") return;

    try{
      const qy = query(collection(db,"users"), where("coachId","==", auth.currentUser.uid));
      const snaps = await getDocs(qy);

      const subs = [];
      snaps.forEach(s=>{
        const d = s.data();
        if(d?.role === "subscriber"){
          subs.push({uid:s.id, name:d.name||"", exp:d.subExpiresAt?.toMillis?.() || null});
        }
      });

      const opts = [`<option value="">— (Edit my data)</option>`].concat(
        subs.map(x=> `<option value="${x.uid}">${escapeHtml(x.name)}</option>`)
      ).join("");

      for(const selId of ["coachTarget","burnCoachTarget","weightCoachTarget"]){
        const sel = el(selId);
        if(sel){
          sel.innerHTML = opts;
          sel.onchange = async ()=>{
            coachTargetUid = sel.value || null;
            for(const other of ["coachTarget","burnCoachTarget","weightCoachTarget"]){
              if(other!==selId && el(other)) el(other).value = sel.value || "";
            }
            if(activeTab==="workouts") await loadWorkouts();
            if(activeTab==="burn") await loadBurnWeek();
            if(activeTab==="weight") await loadWeights();
            if(activeTab==="calculator") await loadCalc();
          };
        }
      }

      subs.sort((a,b)=> (b.exp||0)-(a.exp||0));
      let html = "";
      for(const s of subs){
        const expStr = s.exp ? formatDate(s.exp) : "—";
        const daysLeft = s.exp ? Math.ceil((s.exp - Date.now())/(24*60*60*1000)) : null;
        html += `<div class="msg ok">
          <b>${escapeHtml(s.name)}</b>
          <div class="muted">Ends: <b>${expStr}</b> ${daysLeft!==null ? `• Days left: <b>${daysLeft}</b>` : ""}</div>
        </div>`;
      }
      el("subsList").innerHTML = html || `<div class="muted">No subscribers yet.</div>`;

      el("coachTargetRow").classList.remove("hidden");
      el("burnCoachTargetRow").classList.remove("hidden");
      el("weightCoachTargetRow").classList.remove("hidden");
    }catch(e){
      showMsg(`Coach load error: ${e.code||""} ${e.message||e}`);
    }
  }

  window.adminSetRole = async ()=>{
    clearMsg();
    const uid = auth.currentUser?.uid;
    if(!uid) return showMsg("Please login.");
    if(currentProfile?.role !== "admin") return showMsg("Admin only.");
    const targetUid = (el("adminTargetUid").value||"").trim();
    const role = el("adminRole").value;
    if(!targetUid) return showMsg("Enter target UID.");
    try{
      await updateDoc(doc(db,"users",targetUid), { role, updatedAt: serverTimestamp() });
      showMsg("Role updated ✅", true);
    }catch(e){
      showMsg(`Admin error: ${e.code||""} ${e.message||e}`);
    }
  };

  async function deleteCollectionDocs(pathColl){
    const qs = await getDocs(pathColl);
    const batch = writeBatch(db);
    let count = 0;
    qs.forEach(docu=>{ batch.delete(docu.ref); count++; });
    if(count>0) await batch.commit();
    return count;
  }

  window.adminResetUserData = async ()=>{
    clearMsg();
    if(currentProfile?.role !== "admin") return showMsg("Admin only.");
    const target = (el("resetUid").value||"").trim();
    if(!target) return showMsg("Enter UID.");
    try{
      await deleteDoc(doc(db,"users",target,"calculator","current")).catch(()=>{});
      await deleteDoc(doc(db,"users",target,"workouts","plan")).catch(()=>{});
      await deleteCollectionDocs(collection(db,"users",target,"burnLogs")).catch(()=>{});
      await deleteCollectionDocs(collection(db,"users",target,"weightLogs")).catch(()=>{});
      showMsg("Reset done ✅", true);
    }catch(e){
      showMsg(`Reset error: ${e.code||""} ${e.message||e}`);
    }
  };

  async function checkSubscriptionOrSignOut(profile){
    if(profile?.role !== "subscriber") return true;
    const exp = profile?.subExpiresAt;
    if(!exp) return true;
    const expMs = exp.toMillis ? exp.toMillis() : Number(exp);
    if(!isFinite(expMs)) return true;

    if(Date.now() > expMs){
      showMsg("Subscription expired. Contact your coach.", false);
      await signOut(auth);
      return false;
    }
    return true;
  }

  onAuthStateChanged(auth, async (user)=>{
    if(user){
      el("conn").textContent = "Firebase: CONNECTED";
      el("logoutBtn").disabled = false;
      el("sessEmail").textContent = user.email || "—";

      try{
        const snap = await getDoc(doc(db,"users",user.uid));
        if(!snap.exists()){
          await setDoc(doc(db,"users",user.uid), {
            name: user.email?.split("@")[0] || "User",
            role: "user",
            active: true,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          }, {merge:true});
        }
        const snap2 = await getDoc(doc(db,"users",user.uid));
        currentProfile = snap2.data();
      }catch(e){
        showMsg(`Profile load blocked: ${e.code||""} ${e.message||e}`);
        return;
      }

      const ok = await checkSubscriptionOrSignOut(currentProfile);
      if(!ok) return;

      const role = currentProfile?.role || "unknown";
      el("sessRole").textContent = "ROLE: " + role;

      if(role === "admin"){
        el("sessUid").classList.remove("hidden");
        el("sessUid").textContent = "UID: " + user.uid;
      } else {
        el("sessUid").classList.add("hidden");
        el("sessUid").textContent = "UID: —";
      }

      if(role === "subscriber" && currentProfile?.subExpiresAt){
        const expMs = currentProfile.subExpiresAt.toMillis();
        const startMs = currentProfile.subStartAt?.toMillis?.() || null;
        const daysLeft = Math.ceil((expMs - Date.now())/(24*60*60*1000));

        el("sessSub").classList.remove("hidden");
        el("sessSub").textContent = "SUB: exp " + formatDate(expMs);

        el("subBox").classList.remove("hidden");
        el("subInfo").innerHTML =
          `Start: <b>${startMs ? formatDate(startMs) : "—"}</b><br>
           Expiry: <b>${formatDate(expMs)}</b><br>
           Days left: <b>${daysLeft}</b>`;
      } else {
        el("sessSub").classList.add("hidden");
        el("subBox").classList.add("hidden");
      }

      el("pName").value = currentProfile?.name || "";
      el("pRole").value = role;

      el("tCoach").classList.toggle("hidden", !(role==="coach" || role==="admin"));
      el("tAdmin").classList.toggle("hidden", role!=="admin");

      if(role === "coach"){
        await loadCoachSubscribers();
      } else {
        el("coachTargetRow").classList.add("hidden");
        el("burnCoachTargetRow").classList.add("hidden");
        el("weightCoachTargetRow").classList.add("hidden");
        coachTargetUid = null;
      }

      fillSelectRange("cWeight", 0, 200);
      fillSelectRange("cHeight", 130, 210);
      fillSelectRange("cAge", 14, 80);

      el("authCard").classList.add("hidden");
      el("appCard").classList.remove("hidden");

      await setAppTab("profile");
    } else {
      currentProfile = null;
      coachTargetUid = null;

      el("conn").textContent = "Firebase: —";
      el("logoutBtn").disabled = true;
      el("sessEmail").textContent = "—";
      el("sessRole").textContent = "ROLE: —";
      el("sessUid").classList.add("hidden");
      el("sessSub").classList.add("hidden");

      el("authCard").classList.remove("hidden");
      el("appCard").classList.add("hidden");
    }
  });
</script>
</body>
</html>
